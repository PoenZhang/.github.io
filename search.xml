<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Java Thread ç®€æ</title>
      <link href="2020/10/30/Java_Thread/"/>
      <url>2020/10/30/Java_Thread/</url>
      
        <content type="html"><![CDATA[<h2 id="1-Threadä»£è¡¨ä»€ä¹ˆï¼Ÿ"><a href="#1-Threadä»£è¡¨ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1.Threadä»£è¡¨ä»€ä¹ˆï¼Ÿ"></a>1.Threadä»£è¡¨ä»€ä¹ˆï¼Ÿ</h2><p>Q: â€œJava åˆ›å»ºçº¿ç¨‹çš„å‡ ç§æ–¹å¼â€ A: â€œå®ç°Runnableã€Callableã€‚çº¿ç¨‹æ± ã€ç»§æ‰¿Threadâ€ are you ok ?ã€‚</p><p>é€šè¿‡æ·±å…¥ç†è§£JVMè¿™æœ¬ä¹¦ï¼Œæˆ‘ä»¬çŸ¥é“Javaçº¿ç¨‹æ¨¡å‹æ˜¯ä¸€ä¸€å¯¹åº”æ¨¡å‹ï¼Œå³ä¸€ä¸ªJavaçº¿ç¨‹å¯¹åº”æ“ä½œç³»ç»Ÿä¸€ä¸ªè½»é‡çº§è¿›ç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ­£å¸¸new Thread().start()è¿™ä¸ªåŠ¨ä½œï¼Œä¼šè®©æ“ä½œç³»ç»Ÿä¸­å¤šå‡ºä¸€ä¸ªè½»é‡çº§è¿›ç¨‹ã€‚æ‰€ä»¥ï¼Œåº”è¯¥æ˜¯new Thread().start() å¯¹åº”ä¸€ä¸ªçº¿ç¨‹å®ä½“æ‰å¯¹ï¼Œå’ŒRunnableã€Callableæœ‰å•¥å…³ç³»ï¼Ÿã€‚</p><p>è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘æƒ³è¡¨è¾¾çš„ğŸ˜‚  <a href="https://www.linuxidc.com/Linux/2016-03/128997.htm">https://www.linuxidc.com/Linux/2016-03/128997.htm</a></p><pre><code>/*** Runnableã€Callableåº”è¯¥ç®—æ˜¯çº¦å®šçš„ä»»åŠ¡æ¥å£,å› ä¸ºThreadä¸­æ˜¯æ‰§è¡Œçš„Runnable targetçš„runçš„,* å®é™…çº¿ç¨‹çš„åˆ›å»ºåªæœ‰new Thread().start0()* Threadå¯¹è±¡åœ¨æœªè°ƒç”¨æœ¬åœ°æ–¹æ³•start0()ä¹‹å‰åº”è¯¥æ˜¯æ²¡æœ‰åœ¨æ“ä½œç³»ç»Ÿä¸­åˆ›å»ºå¯¹åº”çš„è½»é‡çº§è¿›ç¨‹çš„* #è¿™åªæ˜¯æˆ‘åœ¨å½“å‰æ°´å¹³ä¸‹çš„è‡ªæˆ‘ç†è§£,æ°´å¹³æœ‰é™ï¼Œè§è°…ã€‚*/public class Thread implements Runnable{    /* What will be run. */    private Runnable target;    @Override    public void run() {        if (target != null) {            target.run();        }    }    ........}</code></pre><h2 id="2-Thread-çŠ¶æ€å˜åŒ–"><a href="#2-Thread-çŠ¶æ€å˜åŒ–" class="headerlink" title="2.Thread çŠ¶æ€å˜åŒ–"></a>2.Thread çŠ¶æ€å˜åŒ–</h2><p><a href="https://imgchr.com/i/BtcVXR"><img src="https://s1.ax1x.com/2020/10/30/BtcVXR.png" alt="BtcVXR.png"></a></p><p>çº¿ç¨‹çŠ¶æ€å›¾</p><ul><li><p>new Thread() <em>NEW</em>çŠ¶æ€ æ­¤æ—¶åªæ˜¯å †åŒºä¸­å¤šäº†ä¸€ä¸ªThreadå¯¹è±¡ï¼Œæ“ä½œç³»ç»Ÿå¹¶æ²¡æœ‰ç›¸åº”çš„è¿›ç¨‹åˆ›å»º</p></li><li><p>thread.start() <em>RUNNABLE</em>çŠ¶æ€ æ“ä½œç³»ç»Ÿä¸­åˆ›å»ºäº†ç›¸åº”è¿›ç¨‹ï¼Œç­‰å¾…cpuè°ƒåº¦</p></li><li><p>RunningçŠ¶æ€  cpuè°ƒåº¦æ‰§è¡Œé˜¶æ®µ,å³å›è°ƒæ‰§è¡ŒThread.run()æ–¹æ³•çš„çŠ¶æ€</p></li><li><ul><li>runæ–¹æ³•æ‰§è¡Œå®Œæˆ  -&gt; åˆ™çº¿ç¨‹æ­£å¸¸é€€å‡ºTERMINATEDçŠ¶æ€</li><li>runæ–¹æ³•ä¸­æ‰§è¡Œä»¥ä¸‹</li></ul></li><li><ul><li><ul><li><em>sleep(long)</em></li><li><em>Object#wait(long)</em>  <em>å’Œå¯¹åº”Object#notify() æ–¹æ³•éƒ½å¿…é¡»åœ¨synchronized (obj){} åŒæ­¥åŒºåŸŸä¸­æ‰èƒ½ä½¿ç”¨</em></li><li><em>Thread#join(long)</em></li><li><em>LockSupport#parkNanos</em></li><li><em>LockSupport#parkUntil</em></li></ul></li></ul></li></ul><p>â€‹    è¿›å…¥<em>TIMED_WAITING**çŠ¶æ€ã€‚è®©å½“å‰çº¿ç¨‹åœæ­¢ä¸€æ®µæ—¶é—´,æ—¶é—´ç‚¹åˆ°åˆ™æ¢å¤æ‰§è¡Œ -&gt;</em> <em>RUNNABLE**çŠ¶æ€</em></p><ul><li><ul><li><em>runæ–¹æ³•æ‰§è¡Œä»¥ä¸‹æ–¹æ³•</em></li></ul></li><li><ul><li><ul><li><em>object#wait()  ç†è§£: é‡Šæ”¾å½“å‰çº¿ç¨‹æŒæœ‰çš„objectå¯¹è±¡é”,å¹¶å°†å½“å‰çº¿ç¨‹ç§»åŠ¨åˆ°objectçš„waittingé˜Ÿåˆ—ä¸­,</em></li></ul></li></ul></li></ul><p><em>æ­¤çŠ¶æ€çš„çº¿ç¨‹éœ€è¦<strong>Object#notify()ï½œ</strong>Object#notifyAll() æ¥æ˜¾ç¤ºå°†çº¿ç¨‹ä»ç›¸åº”å¯¹è±¡çš„waitingé˜Ÿåˆ—ç§»é™¤ã€‚</em></p><ul><li><ul><li><ul><li><em>thread.join()  ç†è§£: åº•å±‚ä¹Ÿæ˜¯waitæ–¹æ³•,æ‰€ä»¥ä¹Ÿéœ€è¦å”¤é†’,åªä¸è¿‡è¿™ä¸ªå”¤é†’æ˜¯jvmæ¥åšçš„ã€‚å½“threadç±»æ‰§è¡Œå®Œæˆä»¥å,ä¼š**notifyAll()**ä¸€æ¬¡ï¼Œå”¤é†’waitåœ¨thredå¯¹è±¡ä¸Šçš„çº¿ç¨‹ã€‚</em></li></ul></li></ul></li></ul><p>å‚è€ƒèµ„æ–™ <a href="https://www.jianshu.com/p/fc51be7e5bc0">https://www.jianshu.com/p/fc51be7e5bc0</a></p><ul><li><ul><li><ul><li><em>LockSupport#park()  éœ€è¦å¯¹åº”çš„**LockSupport#unpark(Thread)è§£é™¤</em> <em>WAITING**çŠ¶æ€</em></li></ul></li></ul></li></ul><p><em>çº¿ç¨‹è¿›å…¥<strong>WAITING</strong>çŠ¶æ€ã€‚</em></p><ul><li><ul><li><em>runæ–¹æ³•æ‰§è¡Œ</em></li></ul></li><li><ul><li><ul><li><em>Thread.<strong>yield</strong>()  è®©å‡ºcpu</em></li></ul></li></ul></li></ul><p><em>çº¿ç¨‹é‡å›**RUNNABLEçŠ¶æ€ï¼Œç­‰å¾…cpuè°ƒåº¦</em></p><ul><li><em>BLOCKED</em>çŠ¶æ€:çº¿ç¨‹å¤„äºé”å¯¹è±¡çš„<em>sync</em>é˜Ÿåˆ—ä¸­çš„çŠ¶æ€ã€‚</li></ul><p>å†çœ‹ä¸‹æ‰€è°“çš„å¯¹è±¡çš„<em>waiting</em>é˜Ÿåˆ—å’Œ<em>sync</em>é˜Ÿåˆ—ã€‚è¿™å—æ¶‰åŠåˆ°<em>synchronized</em> é”å…³é”®å­—çš„è§£æï¼Œæ­¤å¤„ä¸åšç»†è‡´è§£æï¼Œç®€å•ä»‹ç»ä¸€ä¸‹åœ¨<em>synchronized</em> åŒæ­¥å—ä¸­è°ƒç”¨<em>object#wait() å’Œ</em> <em>o**bject#notify()</em> çš„çº¿ç¨‹å˜åŒ–</p><p><a href="https://imgchr.com/i/BtcEc9"><img src="https://s1.ax1x.com/2020/10/30/BtcEc9.png" alt="BtcEc9.png"></a></p><p>å›¾ç‰‡æ¥æº:<a href="https://blog.csdn.net/pange1991/article/details/53860651">https://blog.csdn.net/pange1991/article/details/53860651</a></p><pre><code>/*** ç›®çš„:t1çº¿ç¨‹waitåœ¨lockå¯¹è±¡ä¸Š,è®©t2æ¥notify t1çº¿ç¨‹* é—®é¢˜:å¦‚ä½•ä¿è¯t1å’Œt2æ‰§è¡Œçš„æœ‰åºæ€§ã€‚ã€ä¸ç”¨jucåŒ…å®ç°ã€‘* åœ¨t2ä¸­ä½¿ç”¨t1.joinæ˜¯æœ‰é—®é¢˜ã€‚*/public class ThreadTest {    private static Object lock = new Object();    private static volatile boolean flag = false;    private static CountDownLatch countDownLatch = new CountDownLatch(1);    private static Semaphore semaphore = new Semaphore(0);    public static void main(String[] args) throws InterruptedException {        Thread t1 = new Thread(new Runnable() {            @Override            public void run() {                synchronized (lock){                    System.out.println(Thread.currentThread().getName() + " waiting");                    try {                        flag = true;//                        countDownLatch.countDown();//                        semaphore.release();                        lock.wait(); //å½“threadè¢«notify,é‡æ–°è·å–é”å,ä»æ­¤å¤„ç»§ç»­æ‰§è¡Œ                        System.out.println("after waiting");                    } catch (InterruptedException e) {                        e.printStackTrace();                    }                }                System.out.println("after sync");            }        });        Thread t2 = new Thread(new Runnable() {            @Override            public void run() {                try {                    //t1.join()é—®é¢˜ï¼joinçš„notifyåŠ¨ä½œåœ¨t1çº¿ç¨‹é€€å‡ºæ—¶æ‰ä¼šè§¦å‘,è€Œ                    //t1çº¿ç¨‹çš„é€€å‡ºåˆä¾èµ–äºt2çš„notifyã€‚æ‰€ä»¥æ­¤å¤„ä¼šé™·å…¥æ­»é”                    while (true) {                        if(!flag){                          continue;                        }//                        countDownLatch.await();//                        semaphore.acquire();                        synchronized (lock) {                            System.out.println(Thread.currentThread().getName() + "notify");                            lock.notify();                            System.out.println(Thread.currentThread().getName() + " ç­‰10så†é‡Šæ”¾é”");                            Thread.sleep(10000);                        }                        break;                    }                } catch (InterruptedException e) {                    e.printStackTrace();                }            }        });        //t2å…ˆå¼€å§‹,ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œéœ€è¦æ€ä¹ˆè§£å†³ï¼Ÿæˆ–è€…è¯´å¦‚ä½•ä¿è¯t1åœ¨t2ä¹‹å‰æ‰§è¡Œ?        t2.start();        t1.start();    }}</code></pre><h2 id="3-Threadå¸¸ç”¨apiåŠå®ç°åŸç†"><a href="#3-Threadå¸¸ç”¨apiåŠå®ç°åŸç†" class="headerlink" title="3.Threadå¸¸ç”¨apiåŠå®ç°åŸç†"></a>3.Threadå¸¸ç”¨apiåŠå®ç°åŸç†</h2><ul><li><p><strong><em>thread.interrupt() ä¸­æ–­çº¿ç¨‹ï¼Œå³è®¾ç½®threadå¼•ç”¨çš„çº¿ç¨‹ä¸­æ–­ä½ä¸ºtrue</em></strong></p></li><li><p><strong><em>thread.isInterrupted(boolean) ä»…è¿”å›****çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€,ä¸”æ˜¯å¦æ¸…é™¤ä¸­æ–­ä½</em></strong></p></li><li><ul><li><strong><em>boolean=true å³thread.interrupted() æ¸…é™¤**<strong><strong>å½“å‰æ‰§è¡Œ**</strong></strong>çº¿ç¨‹ä¸­æ–­ä½,å¹¶è¿”å›æ¸…é™¤ä¹‹å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€</em></strong></li><li><strong><em>boolean=false å³****thread.isInterrupted() è¿”å›threadçº¿ç¨‹æ˜¯å¦ä¸­æ–­</em></strong></li></ul></li><li><p><strong><em>thread.isAlive()  threadæ˜¯å¦å¤„äº startåæœªç»ˆæ­¢é€€å‡ºçŠ¶æ€</em></strong></p></li><li><p><strong><em>thread.join(long) å½“å‰æ‰§è¡Œçº¿ç¨‹waitåœ¨threadä¸Šï¼Œç­‰å¾…notifyã€‚threadçš„notifyå‘ç”Ÿåœ¨runæ‰§è¡Œå®Œæˆé€€å‡ºæ—¶ã€‚</em></strong></p></li></ul><p><strong><em>å‚è€ƒï¼š</em></strong><a href="https://www.jianshu.com/p/fc51be7e5bc0">https://www.jianshu.com/p/fc51be7e5bc0</a></p><ul><li><strong><em>thread.setContextClassLoader(ClassLoader) è®¾ç½®çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œæ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹çš„æ–¹æ³•ä¹‹ä¸€\</em></strong></li></ul><hr><hr>]]></content>
      
      
      <categories>
          
          <category> ç¼–ç ä¸è®¾è®¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java Timerç±»ç®€æ</title>
      <link href="2020/10/30/Java_Timer/"/>
      <url>2020/10/30/Java_Timer/</url>
      
        <content type="html"><![CDATA[<ul><li><h4 id="1-åŠŸèƒ½ç®€ä»‹"><a href="#1-åŠŸèƒ½ç®€ä»‹" class="headerlink" title="1.åŠŸèƒ½ç®€ä»‹"></a>1.åŠŸèƒ½ç®€ä»‹</h4><p>ç®€ä»‹ï¼šç®€å•çš„å•çº¿ç¨‹å®šæ—¶ä»»åŠ¡æ‰§è¡Œç±»ï¼Œå¯ä»¥å¸®åŠ©å¤§å®¶äº†è§£å®šæ—¶ä»»åŠ¡å®ç°çš„åŸç†å’Œæ‰€éœ€çš„åŸºæœ¬ç»„ä»¶ã€‚åœ¨å­¦ä¹ ScheduledThreadPoolExecutoræˆ–åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡å°±ä¼šæœ‰ä¸€ä¸ªæ•´ä½“è®¤çŸ¥ã€‚</p><p>é—®é¢˜ï¼š</p><ul><li><ul><li>åªæ•è·äº†InterruptedExceptionå¼‚å¸¸,ç”±äºTimeræ˜¯å•çº¿ç¨‹ï¼Œæ‰€ä»¥ä¸€æ—¦å‡ºç°å¼‚å¸¸ï¼Œåˆ™çº¿ç¨‹å°±ä¼šç»ˆæ­¢ï¼Œå…¶ä»–ä»»åŠ¡ä¹Ÿå¾—ä¸åˆ°æ‰§è¡Œã€‚</li><li>å•æ‰§è¡Œçº¿ç¨‹åœ¨å¤šä»»åŠ¡æƒ…å†µä¸‹ä¼šæœ‰ä»»åŠ¡æ‰§è¡Œå»¶è¿Ÿï¼Œå¦‚æœåœ¨æ‰§è¡Œä»»åŠ¡æœŸé—´æŸä¸ªTimerTaskè€—æ—¶è¾ƒä¹…ï¼Œé‚£ä¹ˆå°±ä¼šå½±å“å…¶å®ƒä»»åŠ¡çš„è°ƒåº¦ï¼›</li><li>Timerä¸ä¼šæ•è·æ‰§è¡ŒTimerTaskæ—¶æ‰€æŠ›å‡ºçš„å¼‚å¸¸ï¼Œç”±äºTimeræ˜¯å•çº¿ç¨‹ï¼Œæ‰€ä»¥ä¸€æ—¦å‡ºç°å¼‚å¸¸ï¼Œåˆ™çº¿ç¨‹å°±ä¼šç»ˆæ­¢ï¼Œå…¶ä»–ä»»åŠ¡ä¹Ÿå¾—ä¸åˆ°æ‰§è¡Œã€‚</li></ul></li></ul><p><img src="https://s1.ax1x.com/2020/10/30/Bti228.png" alt="img"></p><h4 id="2-ä½¿ç”¨æ–¹å¼"><a href="#2-ä½¿ç”¨æ–¹å¼" class="headerlink" title="2.ä½¿ç”¨æ–¹å¼"></a>2.ä½¿ç”¨æ–¹å¼</h4><p><a href="https://imgchr.com/i/BtiRxS"><img src="https://s1.ax1x.com/2020/10/30/BtiRxS.md.png" alt="BtiRxS.md.png"></a></p><p>delayï¼šä¸ºå»¶è¿Ÿæ‰§è¡Œæ—¶é—´ã€‚periodä¸ºæ‰§è¡Œå‘¨æœŸã€‚å½“periodä¸º0æ—¶ä»£è¡¨åªæ‰§è¡Œä¸€æ¬¡å³ä»»åŠ¡æ‰§è¡Œä¸€æ¬¡åå°±ä¼šä»TaskQueueä¸­ç§»é™¤ã€‚å…¶ä»–apiå‡æ˜¯å¯¹sched(TimerTask task, long time, long period) çš„ä¸Šå±‚ç®€å•å°è£…</p><h4 id="3-å®ç°åŸç†"><a href="#3-å®ç°åŸç†" class="headerlink" title="3.å®ç°åŸç†"></a>3.å®ç°åŸç†</h4><p>Timerä¸»è¦ç”± TimerThread ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹ã€TaskQueue ä»»åŠ¡é˜Ÿåˆ—ã€TimerTaskä»»åŠ¡å®ä½“ ä¸‰éƒ¨åˆ†æ„æˆã€‚</p><p>å³å®šæ—¶ä»»åŠ¡çš„åŸºæœ¬ç»„æˆã€‚ä»»åŠ¡æ‰§è¡Œè€…(å•ä¸€çº¿ç¨‹æˆ–çº¿ç¨‹æ± )ï¼Œä»»åŠ¡å®ä½“(ä¸€èˆ¬éœ€è¦æœ‰æ‰§è¡Œæ—¶é—´ç‚¹å’Œæ‰§è¡Œå‘¨æœŸçš„å±æ€§,    å¦åˆ™è°çŸ¥é“å•¥æ—¶å€™ä½ éœ€è¦æ‰§è¡Œäº†)ï¼Œä»»åŠ¡é˜Ÿåˆ—(æœ‰åº!)ã€‚</p><ul><li><ul><li>TimerTaskï¼Œåœ¨RunnubleåŸºç¡€ä¸Šå¢åŠ äº†ä¸€ç³»åˆ—å±æ€§ã€‚ä¸»è¦çœ‹nextExecutionTimeå’Œperiodã€‚</li></ul></li></ul><p>nextExecutionTimeæ˜¯ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´ç‚¹,é€šè¿‡åˆå§‹æ—¶é—´å’Œperiodè®¡ç®—å¾—æ¥ã€‚periodä¸ºä»»åŠ¡æ‰§è¡Œå‘¨æœŸ</p><pre><code>public abstract class TimerTask implements Runnable {    final Object lock = new Object();    // ä»»åŠ¡çŠ¶æ€    int state = VIRGIN;    static final int VIRGIN = 0;    static final int SCHEDULED   = 1;    static final int EXECUTED    = 2;    static final int CANCELLED   = 3;    //ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´    long nextExecutionTime;    //æ‰§è¡Œå‘¨æœŸ    long period = 0;    protected TimerTask() {    }    public abstract void run();    //ä»»åŠ¡å–æ¶ˆ    public boolean cancel() {        synchronized(lock) {            boolean result = (state == SCHEDULED);            state = CANCELLED;            return result;        }    }    //è®¡ç®—ä¸‹ä¸€æ¬¡ä»»åŠ¡æ‰§è¡Œæ—¶é—´ç‚¹    public long scheduledExecutionTime() {        synchronized(lock) {            return (period &lt; 0 ? nextExecutionTime + period                               : nextExecutionTime - period);        }    }}</code></pre><ul><li><ul><li>TaskQueue ä»»åŠ¡é˜Ÿåˆ—ã€‚é€šè¿‡å †æ’åºçš„æ€æƒ³ä¿è¯TimerTask.nextExecutionTimeå€¼æœ€å°çš„ä»»åŠ¡å®ä½“ï¼Œæ€»æ˜¯åœ¨é˜Ÿåˆ—ç¬¬ä¸€ä½ï¼Œæ­¤æ—¶ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹åªéœ€è¦è·å–é˜Ÿåˆ—ç¬¬ä¸€ä¸ªä»»åŠ¡å°±èƒ½åˆ¤æ–­æ˜¯å¦æœ‰éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚</li></ul></li></ul><pre><code>/*** åªä»‹ç»ä¸»æµç¨‹å‡ ä¸ªä¸»è¦çš„æ–¹æ³•* æ­¤ç±»éçº¿ç¨‹å®‰å…¨,å¯ä»¥æ³¨æ„åˆ°åœ¨ä½¿ç”¨è¿™ä¸ªç±»æ—¶ï¼Œéƒ½æœ‰å…ˆåŠ é”çš„åŠ¨ä½œã€‚* å»ºè®®:è‡ªå·±å¯ä»¥å®ç°ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚* ä»»åŠ¡é˜Ÿåˆ—ç‰¹ç‚¹ï¼šæœ‰åº*/class TaskQueue{    /**    * åˆå§‹å¤§å°128ã€‚ä»»åŠ¡çš„ç¬¬ä¸€ä¸ªåœ¨queue[1]è€Œéqueue[0]æ³¨æ„ã€‚    * ç¬¦åˆå°é¡¶å †çš„æ•°ç»„ã€‚å½“çˆ¶èŠ‚ç‚¹ä¸ºNæ—¶,å·¦å­©å­ä¸º2N,åˆå­©å­2N+1ã€‚è¿™ä¹Ÿæ˜¯ç¬¬ä¸€ä¸ªä»queue[1]å¼€å§‹    * ç©ºç½®ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»1å¼€å§‹æ¯”è¾ƒå¥½è®¡ç®—    */    private TimerTask[] queue = new TimerTask[128];    private int size = 0;    int size() {        return size;    }    //å‘é˜Ÿåˆ—ä¸­æ–°å¢ä»»åŠ¡å®ä½“    void add(TimerTask task) {        // Grow backing store if necessary        if (size + 1 == queue.length)            queue = Arrays.copyOf(queue, 2*queue.length);        //æ·»åŠ åˆ°æ•°ç»„æœ«å°¾        queue[++size] = task;        //æ­¤æ—¶ä¸ä¸€å®šæ»¡è¶³å°é¡¶å †,è¿›è¡Œå°é¡¶å †fix        fixUp(size);    }    //è·å–é˜Ÿåˆ—ä¸­nextExecutionTimeæœ€å°çš„èŠ‚ç‚¹,å³å°é¡¶å †çš„é¡¶ç‚¹    TimerTask getMin() {        return queue[1];    }    //ç§»é™¤é¡¶ç‚¹    void removeMin() {        queue[1] = queue[size];        queue[size--] = null;  // Drop extra reference to prevent memory leak        //å°é¡¶å †fix        fixDown(1);    }    //æ›´æ–°ä»»åŠ¡æ‰§è¡Œæ—¶é—´    void rescheduleMin(long newTime) {        queue[1].nextExecutionTime = newTime;        //å°é¡¶å †fix        fixDown(1);    }    boolean isEmpty() {        return size==0;    }    void clear() {        // Null out task references to prevent memory leak        for (int i=1; i&lt;=size; i++)            queue[i] = null;        size = 0;    }    //fixå°é¡¶å †,ä¿è¯å½“å‰æ•°ç»„ç¬¦åˆå°é¡¶å †è§„åˆ™ï¼Œå †åº•å¼€å§‹ï¼Œè‡ªä¸‹è€Œä¸Š    private void fixUp(int k) {        while (k &gt; 1) {            int j = k &gt;&gt; 1;            if (queue[j].nextExecutionTime &lt;= queue[k].nextExecutionTime)                break;            TimerTask tmp = queue[j];  queue[j] = queue[k]; queue[k] = tmp;            k = j;        }    }    //fixå°é¡¶å †,ä¿è¯å½“å‰æ•°ç»„ç¬¦åˆå°é¡¶å †è§„åˆ™ï¼Œå †é¡¶å¼€å§‹ï¼Œè‡ªä¸Šè€Œä¸‹    private void fixDown(int k) {        int j;        while ((j = k &lt;&lt; 1) &lt;= size &amp;&amp; j &gt; 0) {            if (j &lt; size &amp;&amp;                queue[j].nextExecutionTime &gt; queue[j+1].nextExecutionTime)                j++; // j indexes smallest kid            if (queue[k].nextExecutionTime &lt;= queue[j].nextExecutionTime)                break;            TimerTask tmp = queue[j];  queue[j] = queue[k]; queue[k] = tmp;            k = j;        }    }}</code></pre><ul><li><ul><li>TimerThread ä»»åŠ¡çš„å®é™…æ‰§è¡Œè€…,å°è£…ä»»åŠ¡çš„æ‰§è¡Œé€»è¾‘ã€‚å®é™…å°±æ˜¯å¾ªç¯ä»»åŠ¡é˜Ÿåˆ—,æ‰§è¡Œå½“å‰æ—¶é—´ç‚¹å¯æ‰§è¡Œçš„ä»»åŠ¡</li></ul></li></ul><pre><code>class TimerThread extends Thread {    /**     * ä»»åŠ¡åœæ­¢æ ‡è¯†     */    boolean newTasksMayBeScheduled = true;    /**     * ä»»åŠ¡é˜Ÿåˆ—çš„å¼•ç”¨     */    private TaskQueue queue;    TimerThread(TaskQueue queue) {        this.queue = queue;    }    public void run() {        try {            mainLoop();        } finally {            // è¯´æ˜mainLoopé€€å‡ºäº†,è®¾ç½®æ ‡è¯†,æ¸…é™¤ä»»åŠ¡é˜Ÿåˆ—            synchronized(queue) {                newTasksMayBeScheduled = false;                queue.clear();  // Eliminate obsolete references            }        }    }    /**     * The main timer loop.  (See class comment.)     */    private void mainLoop() {        while (true) {            try {                TimerTask task;                boolean taskFired;                synchronized(queue) {                    //ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºä¸”ä»»åŠ¡çº¿ç¨‹ä¸é€€å‡ºæ—¶wait,å½“newTasksMayBeScheduledä¸ºfalse                    //ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºæ‰§è¡Œçº¿ç¨‹å°±å¯ä»¥é€€å‡ºäº†                    while (queue.isEmpty() &amp;&amp; newTasksMayBeScheduled)                        queue.wait();                    if (queue.isEmpty())                        break; // Queue is empty and will forever remain; die                    // Queue nonempty; look at first evt and do the right thing                    long currentTime, executionTime;                    task = queue.getMin();                    synchronized(task.lock) {                        if (task.state == TimerTask.CANCELLED) {                            queue.removeMin();                            continue;  // No action required, poll queue again                        }                        currentTime = System.currentTimeMillis();                        executionTime = task.nextExecutionTime;                        //åˆ¤æ–­å½“å‰æ—¶é—´ç‚¹æ˜¯å¦æœ‰å¯æ‰§è¡Œä»»åŠ¡                        if (taskFired = (executionTime&lt;=currentTime)) {                            //æ‰§è¡Œå‘¨æœŸä¸º0å³ï¼Œåªæ‰§è¡Œä¸€æ¬¡ï¼Œä»»åŠ¡åˆ é™¤                            if (task.period == 0) { // Non-repeating, remove                                queue.removeMin();                                task.state = TimerTask.EXECUTED;                            } else { // æ›´æ–°ä»»åŠ¡æ—¶é—´                                queue.rescheduleMin(                                  task.period&lt;0 ? currentTime   - task.period                                                : executionTime + task.period);                            }                        }                    }                    //å½“å‰æ‰§è¡Œæ—¶é—´æ— å¯æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™ç­‰å¾…åˆ°æœ€è¿‘çš„æ‰§è¡Œæ—¶é—´ç‚¹                    if (!taskFired) // Task hasn't yet fired; wait                        queue.wait(executionTime - currentTime);                }                //ä»»åŠ¡æ‰§è¡Œ                if (taskFired)  // Task fired; run it, holding no locks                    task.run();            } catch(InterruptedException e) {                //æ­¤å¤„åªcatchäº†InterruptedExceptionã€‚å…¶ä»–å¼‚å¸¸æœªæ•è·ï¼Œæˆ–å¯¼è‡´mainLoopé€€å‡º            }        }    }}</code></pre><p>TimeråŠŸèƒ½ï¼šå‘å¤–æä¾›api -&gt; åˆå§‹åŒ–å¯åŠ¨ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹ï¼Œ -&gt; åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡ -&gt; å®šæ—¶ä»»åŠ¡æäº¤åˆ°ä»»åŠ¡é˜Ÿåˆ—</p><pre><code>public class Timer {    //åˆå§‹åŒ–ä»»åŠ¡é˜Ÿåˆ—    private final TaskQueue queue = new TaskQueue();    /**     * The timer thread.     */    private final TimerThread thread = new TimerThread(queue);    //1.å¯åŠ¨ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹    public Timer(String name) {        thread.setName(name);        thread.start();    }    private void sched(TimerTask task, long time, long period) {        if (time &lt; 0)            throw new IllegalArgumentException("Illegal execution time.");        // Constrain value of period sufficiently to prevent numeric        // overflow while still being effectively infinitely large.        if (Math.abs(period) &gt; (Long.MAX_VALUE &gt;&gt; 1))            period &gt;&gt;= 1;        synchronized(queue) {            if (!thread.newTasksMayBeScheduled)                throw new IllegalStateException("Timer already cancelled.");            //2.åˆå§‹åŒ–ä»»åŠ¡å®ä½“nextExecutionTimeå’Œperiodæ‰§è¡Œå‘¨æœŸ            synchronized(task.lock) {                if (task.state != TimerTask.VIRGIN)                    throw new IllegalStateException(                        "Task already scheduled or cancelled");                task.nextExecutionTime = time;                task.period = period;                task.state = TimerTask.SCHEDULED;            }            //3.æäº¤ä»»åŠ¡åˆ°ä»»åŠ¡é˜Ÿåˆ—            queue.add(task);            //4.å½“å‰ä»»åŠ¡ä¸ºæœ€æ–°ä»»åŠ¡ï¼Œåˆ™å”¤é†’waitçš„æ‰§è¡Œçº¿ç¨‹ã€‚å¯¹åº”TimerThread mainLoopä¸­çš„ä¸¤ä¸ªwaitç‚¹            if (queue.getMin() == task)                queue.notify();        }    }}</code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> ç¼–ç ä¸è®¾è®¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>23ç§è®¾è®¡æ¨¡å¼ï¼ˆ1ï¼‰-åˆ›å»ºå‹æ¨¡å¼</title>
      <link href="2020/10/30/design_pattern/"/>
      <url>2020/10/30/design_pattern/</url>
      
        <content type="html"><![CDATA[<h2 id="1ã€å•ä¾‹æ¨¡å¼"><a href="#1ã€å•ä¾‹æ¨¡å¼" class="headerlink" title="1ã€å•ä¾‹æ¨¡å¼"></a>1ã€å•ä¾‹æ¨¡å¼</h2><h2 id="ï¼ˆ1ï¼‰ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å•ä¾‹ï¼Ÿ"><a href="#ï¼ˆ1ï¼‰ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å•ä¾‹ï¼Ÿ" class="headerlink" title="ï¼ˆ1ï¼‰ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å•ä¾‹ï¼Ÿ"></a>ï¼ˆ1ï¼‰ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å•ä¾‹ï¼Ÿ</h2><p>   å•ä¾‹æ¨¡å¼ç†è§£èµ·æ¥éå¸¸ç®€å•ï¼Œå³ä¸€ä¸ªç±»åªå…è®¸åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼ˆå¯¹è±¡ï¼‰ï¼Œé‚£è¿™ä¸ªç±»å°±æ˜¯ä¸€ä¸ªå•ä¾‹ç±»ã€‚è¿™ç§è®¾è®¡æ¨¡å¼å°±å«åšå•ä¾‹æ¨¡å¼ï¼Œç®€ç§°å•ä¾‹æ¨¡å¼ï¼Œé‚£ä¹ˆå•ä¾‹æ¨¡å¼å¯ä»¥ç”¨æ¥è§£å†³å“ªäº›é—®é¢˜å‘¢ï¼Ÿ</p><p>ä¾‹1ï¼šæ ‡è¯†å…¨å±€å”¯ä¸€ç±»</p><p>ä»ä¸šåŠ¡ä¸Šæ¥è®²ï¼Œå¦‚æœæœ‰äº›æ•°æ®åœ¨ç³»ç»Ÿä¸­åªåº”ä¿å­˜ä¸€ä»½ï¼Œé‚£å°±æ¯”è¾ƒé€‚åˆè®¾è®¡ä¸ºå•ä¾‹ç±»ï¼Œæ¯”å¦‚é…ç½®ä¿¡æ¯ç±»ã€‚åœ¨ç³»ç»Ÿä¸­æˆ‘ä»¬åªæœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå½“é…ç½®æ–‡ä»¶è¢«åŠ è½½åˆ°å†…å­˜ä»¥åï¼Œä»¥å¯¹è±¡çš„å½¢å¼å­˜åœ¨ï¼Œå°±åº”è¯¥åªæœ‰ä¸€ä¸ªæ­¤ç±»å¯¹è±¡ã€‚</p><p>ä¾‹2ï¼šIDç”Ÿæˆå™¨</p><p>å¦‚æœç¨‹åºä¸­å­˜åœ¨ä¸¤ä¸ªIDç”Ÿæˆå™¨å¯¹è±¡ï¼Œå°±æœ‰å¯èƒ½å­˜åœ¨IDé‡å¤æƒ…å†µï¼Œæ‰€ä»¥åº”è¯¥å°†IDç”Ÿæˆå™¨ç±»è®¾è®¡ä¸ºå•ä¾‹æ¨¡å¼ï¼Œå¹¶ä¸”åœ¨ç”Ÿæˆidçš„æ–¹æ³•ä¸Šåšå¹¶å‘å¤„ç†ã€‚</p><h2 id="ï¼ˆ2ï¼‰å¦‚ä½•å®ç°ä¸€ä¸ªå•ä¾‹ï¼Ÿ"><a href="#ï¼ˆ2ï¼‰å¦‚ä½•å®ç°ä¸€ä¸ªå•ä¾‹ï¼Ÿ" class="headerlink" title="ï¼ˆ2ï¼‰å¦‚ä½•å®ç°ä¸€ä¸ªå•ä¾‹ï¼Ÿ"></a>ï¼ˆ2ï¼‰å¦‚ä½•å®ç°ä¸€ä¸ªå•ä¾‹ï¼Ÿ</h2><p>å•ä¾‹æ¨¡å¼æ¯”è¾ƒç®€å•ï¼Œå°±ä¸å†åšè¿‡å¤šèµ˜è¿°ã€‚ç½‘ä¸Šå¯¹äºå¦‚ä½•å®ç°ä¸€ä¸ªå•ä¾‹ä¹Ÿæœ‰å¾ˆå¤šçš„æ–‡ç« ï¼Œåœ¨è¿™é‡Œç®€å•åšä¸€ä¸‹æè¿°ã€‚</p><p>ç”Ÿæˆä¸€ä¸ªå•ä¾‹å¯¹è±¡ï¼Œæ— éè¦ä¿è¯ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li><ol><li>ç±»çš„æ„é€ å‡½æ•°è¦éƒ½æ˜¯privateç±»å‹çš„ï¼Œé¿å…ä»å¤–éƒ¨ç›´æ¥newäº§ç”Ÿå¯¹è±¡</li><li>éœ€è¦è€ƒè™‘å¯¹è±¡åˆ›å»ºçš„çº¿ç¨‹å®‰å…¨é—®é¢˜</li><li>è€ƒè™‘æ˜¯å¦æ”¯æŒå»¶è¿ŸåŠ è½½</li><li>è€ƒè™‘getInstance()æ€§èƒ½æ˜¯å¦è¶³å¤Ÿ</li></ol></li></ol><p>åˆ›å»ºæ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§</p><ul><li><p>é¥¿æ±‰å¼</p></li><li><ul><li>åœ¨ç±»åŠ è½½çš„æ—¶å€™ï¼Œinstanceé™æ€å®ä¾‹å°±å·²ç»åˆ›å»ºå¹¶åˆå§‹åŒ–å¥½äº†ï¼Œæ‰€ä»¥instanceå®ä¾‹çš„åˆ›å»ºè¿‡ç¨‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä¸è¿‡è¿™ç§çš„æ–¹å¼ä¸æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Œå¯¼è‡´ç³»ç»Ÿå¯åŠ¨å¯èƒ½ä¼šæœ‰å»¶è¿Ÿã€‚ï¼ˆæˆ‘ä¸ªäººæ¯”è¾ƒæ¨èè¿™ç§æ–¹å¼ï¼Œä¸€ä¸ªç±»åªè¦å­˜åœ¨ï¼Œå°±ä¸å¯èƒ½ä¸è¢«ç”¨åˆ°ï¼‰</li></ul></li></ul><pre><code>public class IdGenerator {   private AtomicLong id = new AtomicLong(0);  private static final IdGenerator instance = new IdGenerator();  private IdGenerator() {}  public static IdGenerator getInstance() {    return instance;  }  public long getId() {     return id.incrementAndGet();  }}</code></pre><ul><li><p>æ‡’æ±‰å¼</p></li><li><ul><li>æ‡’æ±‰å¼ç›¸å¯¹äºé¥¿æ±‰å¼çš„ä¼˜åŠ¿å°±æ˜¯æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Œä½†ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå¼•å…¥äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œéœ€è¦åœ¨åˆ›å»ºå®ä¾‹çš„æ–¹æ³•ä¸ŠåŠ é”</li></ul></li></ul><pre><code>public class IdGenerator {   private AtomicLong id = new AtomicLong(0);  private static IdGenerator instance;  private IdGenerator() {}  public static synchronized IdGenerator getInstance() {    if (instance == null) {      instance = new IdGenerator();    }    return instance;  }  public long getId() {     return id.incrementAndGet();  }}</code></pre><ul><li><p>åŒé‡æ£€æµ‹</p></li><li><ul><li>é¥¿æ±‰å¼ä¸æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Œæ‡’æ±‰å¼ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜å’Œå¹¶å‘åº¦é—®é¢˜ï¼Œæœ‰æ²¡æœ‰ä¸€ç§æ–¹å¼æ—¢æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Œåˆèƒ½åœ¨æ€§èƒ½æœ‰ä¿è¯çš„æ–¹æ³•å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯åŒé‡æ£€æµ‹ï¼ˆDouble-Checkï¼‰ã€‚åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œåªæœ‰instanceè¢«åˆ›å»ºä¹‹åï¼Œå³ä¾¿å†è°ƒç”¨getInstanceæ–¹æ³•ä¹Ÿä¸ä¼šåœ¨è¿›å…¥åˆ°åŠ é”é€»è¾‘äº†ã€‚ä½†ä¸‹è¾¹çš„å®ç°æ–¹å¼è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œå› ä¸ºç¼–è¯‘å™¨åœ¨è‡ªåŠ¨ä¼˜åŒ–çš„æ—¶å€™ä¼šæŒ‡ä»¤é‡æ’ï¼Œæœ‰å¯èƒ½ä¼šå¯¼è‡´IdGeneratoeå¯¹è±¡è¢«newå‡ºæ¥å¹¶ä¸”èµ‹å€¼ç»™instanceä¹‹åï¼Œè¿›è¡Œåˆå§‹åŒ–ï¼ˆæ‰§è¡Œæ„é€ æ–¹æ³•çš„é€»è¾‘ï¼‰ä¹‹å‰ï¼Œå°±è¢«å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨äº†ï¼ˆè¿™ç§ç°è±¡å«åšé€¸å‡ºï¼‰ã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜ä¹Ÿå¾ˆç®€å•ï¼Œç»™instanceå¯¹è±¡åŠ ä¸Švolatileå…³é”®å­—å³å¯ï¼ˆvolatileç¦æ­¢é‡æ’ï¼Œå¹¶ä¸”åœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œä¿è¯å˜é‡åœ¨ä¿®æ”¹ä¹‹åï¼Œç«‹åˆ»å¯¹å…¶ä»–çº¿ç¨‹å¯è§ï¼‰</li></ul></li></ul><pre><code>public class IdGenerator {   private AtomicLong id = new AtomicLong(0);  private static IdGenerator instance;  private IdGenerator() {}  public static IdGenerator getInstance() {    if (instance == null) {      synchronized(IdGenerator.class) { // æ­¤å¤„ä¸ºç±»çº§åˆ«çš„é”        if (instance == null) {          instance = new IdGenerator();        }      }    }    return instance;  }  public long getId() {     return id.incrementAndGet();  }}</code></pre><ul><li><p>å†…éƒ¨é™æ€ç±»</p></li><li><ul><li>æœ‰ç‚¹ç±»ä¼¼é¥¿æ±‰å¼ï¼Œä½†åˆèƒ½åšåˆ°å»¶è¿ŸåŠ è½½</li></ul></li></ul><pre><code>public class IdGenerator {   private AtomicLong id = new AtomicLong(0);  private IdGenerator() {}  private static class SingletonHolder{    private static final IdGenerator instance = new IdGenerator();  }  public static IdGenerator getInstance() {    return SingletonHolder.instance;  }  public long getId() {     return id.incrementAndGet();  }}</code></pre><p>SingletonHoleræ˜¯ä¸€ä¸ªå†…éƒ¨é™æ€ï¼Œå½“åŠ è½½å¤–éƒ¨ç±»çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šåˆ›å»ºSingletonHolerå¯¹è±¡ï¼Œåªæœ‰å½“è°ƒç”¨getinstanceæ–¹æ³•çš„æ˜¯ï¼ŒHolderæ‰ä¼šè¢«åŠ è½½ï¼Œè¿™ä¸ªæ—¶å€™åˆ›å»ºinstanceã€‚</p><ul><li>æšä¸¾</li></ul><pre><code>public enum IdGenerator {  INSTANCE;  private AtomicLong id = new AtomicLong(0);  public long getId() {     return id.incrementAndGet();  }}</code></pre><h2 id="2ã€å·¥å‚æ¨¡å¼"><a href="#2ã€å·¥å‚æ¨¡å¼" class="headerlink" title="2ã€å·¥å‚æ¨¡å¼"></a>2ã€å·¥å‚æ¨¡å¼</h2><p>å·¥å‚æ¨¡å¼ä¹Ÿæ˜¯ç»å¸¸è§åˆ°çš„æ¨¡å¼ä¹‹ä¸€ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå·¥å‚æ¨¡å¼å¯ä»¥åˆ†ä¸ºä¸‰ç§æ›´åŠ ç»†åˆ†çš„ç±»å‹ï¼šç®€å•å·¥å‚ï¼Œå·¥å‚æ–¹æ³•å’ŒæŠ½è±¡å·¥å‚ã€‚</p><h3 id="ï¼ˆ1ï¼‰ç®€å•å·¥å‚"><a href="#ï¼ˆ1ï¼‰ç®€å•å·¥å‚" class="headerlink" title="ï¼ˆ1ï¼‰ç®€å•å·¥å‚"></a>ï¼ˆ1ï¼‰ç®€å•å·¥å‚</h3><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦æ ¹æ®é…ç½®é¡¹ç›®ä¸­é…ç½®æ–‡ä»¶çš„åç¼€ï¼Œé€‰æ‹©ä¸åŒçš„é…ç½®è§£æå™¨ï¼Œå°†å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®è§£ææˆå†…å­˜å¯¹è±¡ï¼Œç®€å•æ–¹æ³•å¦‚ä¸‹ï¼š</p><pre><code>public class RuleConfigSource {  public RuleConfig load(String ruleConfigFilePath) {    String ruleConfigFileExtension = getFileExtension(ruleConfigFilePath);    IRuleConfigParser parser = null;    if ("json".equalsIgnoreCase(ruleConfigFileExtension)) {      parser = new JsonRuleConfigParser();    } else if ("xml".equalsIgnoreCase(ruleConfigFileExtension)) {      parser = new XmlRuleConfigParser();    } else if ("yaml".equalsIgnoreCase(ruleConfigFileExtension)) {      parser = new YamlRuleConfigParser();    } else if ("properties".equalsIgnoreCase(ruleConfigFileExtension)) {      parser = new PropertiesRuleConfigParser();    } else {      throw new InvalidRuleConfigException(             "Rule config file format is not supported: " + ruleConfigFilePath);    }    String configText = "";    //ä»ruleConfigFilePathæ–‡ä»¶ä¸­è¯»å–é…ç½®æ–‡æœ¬åˆ°configTextä¸­    RuleConfig ruleConfig = parser.parse(configText);    return ruleConfig;  }  private String getFileExtension(String filePath) {    //...è§£ææ–‡ä»¶åè·å–æ‰©å±•åï¼Œæ¯”å¦‚rule.jsonï¼Œè¿”å›json    return "json";  }}</code></pre><p>ä½†æ˜¯ä¸€ä¸ªå¥½çš„ä»£ç è®¾è®¡ï¼Œä¸ºäº†è®©é€»è¾‘æ›´åŠ æ¸…æ™°ï¼Œå¯è¯»æ€§æ›´å¥½ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å»æ‰å¤§é‡ç¹æ‚çš„åˆ†æ”¯é€»è¾‘ï¼Œå°†åŠŸèƒ½ç‹¬ç«‹çš„ä»£ç å—å°è£…æˆå‡½æ•°ï¼ŒæŒ‰ç…§è¿™ä¸ªé€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥å°†åˆ›å»ºparserçš„é€»è¾‘å‰¥ç¦»å‡ºæ¥ï¼Œè¡ŒæˆcreateParserå‡½æ•°ï¼š</p><pre><code>  public RuleConfig load(String ruleConfigFilePath) {    String ruleConfigFileExtension = getFileExtension(ruleConfigFilePath);    IRuleConfigParser parser = createParser(ruleConfigFileExtension);    if (parser == null) {      throw new InvalidRuleConfigException(              "Rule config file format is not supported: " + ruleConfigFilePath);    }    String configText = "";    //ä»ruleConfigFilePathæ–‡ä»¶ä¸­è¯»å–é…ç½®æ–‡æœ¬åˆ°configTextä¸­    RuleConfig ruleConfig = parser.parse(configText);    return ruleConfig;  }  private String getFileExtension(String filePath) {    //...è§£ææ–‡ä»¶åè·å–æ‰©å±•åï¼Œæ¯”å¦‚rule.jsonï¼Œè¿”å›json    return "json";  }  private IRuleConfigParser createParser(String configFormat) {    IRuleConfigParser parser = null;    if ("json".equalsIgnoreCase(configFormat)) {      parser = new JsonRuleConfigParser();    } else if ("xml".equalsIgnoreCase(configFormat)) {      parser = new XmlRuleConfigParser();    } else if ("yaml".equalsIgnoreCase(configFormat)) {      parser = new YamlRuleConfigParser();    } else if ("properties".equalsIgnoreCase(configFormat)) {      parser = new PropertiesRuleConfigParser();    }    return parser;  }}</code></pre><p>åˆ°è¿™é‡Œè¿˜ä¸å¤Ÿï¼Œæœ¬ç€èŒè´£å•ä¸€åŸåˆ™ï¼Œæˆ‘ä»¬å°†createParserå‡½æ•°å‰¥ç¦»åˆ°ä¸€ä¸ªå•ç‹¬çš„ç±»ä¸­ï¼Œè®©è¿™ä¸ªç±»åªè´Ÿè´£Parserç±»çš„åˆ›å»ºï¼Œé‚£ä¹ˆè¿™ä¸ªç±»ï¼Œå°±å¯ä»¥è¢«ç§°ä¸ºç®€å•å·¥å‚ï¼š</p><pre><code>public class RuleConfigSource {  public RuleConfig load(String ruleConfigFilePath) {    String ruleConfigFileExtension = getFileExtension(ruleConfigFilePath);    IRuleConfigParser parser = RuleConfigParserFactory.createParser(ruleConfigFileExtension);    if (parser == null) {      throw new InvalidRuleConfigException(              "Rule config file format is not supported: " + ruleConfigFilePath);    }    String configText = "";    //ä»ruleConfigFilePathæ–‡ä»¶ä¸­è¯»å–é…ç½®æ–‡æœ¬åˆ°configTextä¸­    RuleConfig ruleConfig = parser.parse(configText);    return ruleConfig;  }  private String getFileExtension(String filePath) {    //...è§£ææ–‡ä»¶åè·å–æ‰©å±•åï¼Œæ¯”å¦‚rule.jsonï¼Œè¿”å›json    return "json";  }}public class RuleConfigParserFactory {  public static IRuleConfigParser createParser(String configFormat) {    IRuleConfigParser parser = null;    if ("json".equalsIgnoreCase(configFormat)) {      parser = new JsonRuleConfigParser();    } else if ("xml".equalsIgnoreCase(configFormat)) {      parser = new XmlRuleConfigParser();    } else if ("yaml".equalsIgnoreCase(configFormat)) {      parser = new YamlRuleConfigParser();    } else if ("properties".equalsIgnoreCase(configFormat)) {      parser = new PropertiesRuleConfigParser();    }    return parser;  }}</code></pre><p>è¿˜æœ‰æ²¡æœ‰ä¼˜åŒ–çš„ç©ºé—´ï¼Ÿå¯¹äºä¸€ä¸ªè§£æç±»æ¥è¯´ï¼Œæ˜¯è§£æå®Œå³å¼ƒçš„ï¼Œå¯¹äºè¿™æ ·çš„è·Ÿæ•°æ®æ— å…³çš„å·¥å…·ç±»ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ç¼“å­˜ä¸€ä»½ï¼Œç¬¬ä¸€æ¬¡åˆ›å»ºä¹‹åç¼“å­˜èµ·æ¥ï¼Œç¬¬äºŒæ¬¡å†è¯·æ±‚ç›´æ¥è¿”å›ã€‚</p><p>ç¼ºç‚¹åœ¨å“ªé‡Œï¼Ÿ</p><ul><li>è¿åå¼€é—­åŸåˆ™ï¼šå¦‚æœæˆ‘ä»¬è¦å¢åŠ æ–°çš„è§£æè§„åˆ™ï¼Œé‚£ä¹ˆå°±è¦æ›´æ”¹åˆ°createParseræ–¹æ³•ï¼Œå¢åŠ æ–°çš„if/elseåˆ†æ”¯</li><li>å¤§é‡ç¹æ‚çš„åˆ†æ”¯é€»è¾‘ï¼šå¯è¯»æ€§å’Œç»´æŠ¤æ€§é™ä½</li></ul><h3 id="ï¼ˆ2ï¼‰å·¥å‚æ–¹æ³•"><a href="#ï¼ˆ2ï¼‰å·¥å‚æ–¹æ³•" class="headerlink" title="ï¼ˆ2ï¼‰å·¥å‚æ–¹æ³•"></a>ï¼ˆ2ï¼‰å·¥å‚æ–¹æ³•</h3><p>å¦‚æœæˆ‘ä»¬éè¦å°†if/elseåˆ†æ”¯é€»è¾‘å–æ¶ˆï¼Œè¯¥æ€ä¹ˆåšï¼Ÿ</p><p>å¤šæ€å†™æ³•å¦‚ä¸‹ï¼š</p><pre><code>public interface IRuleConfigParserFactory {  IRuleConfigParser createParser();}public class JsonRuleConfigParserFactory implements IRuleConfigParserFactory {  @Override  public IRuleConfigParser createParser() {    return new JsonRuleConfigParser();  }}public class XmlRuleConfigParserFactory implements IRuleConfigParserFactory {  @Override  public IRuleConfigParser createParser() {    return new XmlRuleConfigParser();  }}public class YamlRuleConfigParserFactory implements IRuleConfigParserFactory {  @Override  public IRuleConfigParser createParser() {    return new YamlRuleConfigParser();  }}public class PropertiesRuleConfigParserFactory implements IRuleConfigParserFactory {  @Override  public IRuleConfigParser createParser() {    return new PropertiesRuleConfigParser();  }}</code></pre><p>è¿™æ ·å†™çš„è¯ï¼Œæˆ‘ä»¬å¦‚æœè¦å¢åŠ æ–°çš„è§£æç±»çš„è¯ï¼Œåªè¦æ–°å¢æ¥å£çš„å®ç°ç±»å³å¯ï¼Œç¬¦åˆå¼€é—­åŸåˆ™ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ—¶å€™å¦‚ä½•ä½¿ç”¨ï¼Ÿ</p><pre><code>public class RuleConfigSource {  public RuleConfig load(String ruleConfigFilePath) {    String ruleConfigFileExtension = getFileExtension(ruleConfigFilePath);    IRuleConfigParserFactory parserFactory = null;    if ("json".equalsIgnoreCase(ruleConfigFileExtension)) {      parserFactory = new JsonRuleConfigParserFactory();    } else if ("xml".equalsIgnoreCase(ruleConfigFileExtension)) {      parserFactory = new XmlRuleConfigParserFactory();    } else if ("yaml".equalsIgnoreCase(ruleConfigFileExtension)) {      parserFactory = new YamlRuleConfigParserFactory();    } else if ("properties".equalsIgnoreCase(ruleConfigFileExtension)) {      parserFactory = new PropertiesRuleConfigParserFactory();    } else {      throw new InvalidRuleConfigException("Rule config file format is not supported: " + ruleConfigFilePath);    }    IRuleConfigParser parser = parserFactory.createParser();    String configText = "";    //ä»ruleConfigFilePathæ–‡ä»¶ä¸­è¯»å–é…ç½®æ–‡æœ¬åˆ°configTextä¸­    RuleConfig ruleConfig = parser.parse(configText);    return ruleConfig;  }  private String getFileExtension(String filePath) {    //...è§£ææ–‡ä»¶åè·å–æ‰©å±•åï¼Œæ¯”å¦‚rule.jsonï¼Œè¿”å›json    return "json";  }}</code></pre><p>å¯ä»¥çœ‹åˆ°åˆ›å»ºè§£æå¯¹è±¡çš„æ–¹æ³•åˆè€¦åˆè¿›äº†loadå‡½æ•°ä¸­ï¼Œå…¶å®è·Ÿç¬¬ä¸€ç§æ–¹å¼æ²¡æœ‰å¤ªå¤§åŒºåˆ«ï¼Œåè€Œçœ‹èµ·æ¥æ›´å¤æ‚äº†ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä¸ºå·¥å‚ç±»å†åˆ›å»ºä¸€ä¸ªç®€å•å·¥å‚ï¼Œçœ‹ä»£ç ï¼š</p><pre><code>public class RuleConfigSource {  public RuleConfig load(String ruleConfigFilePath) {    String ruleConfigFileExtension = getFileExtension(ruleConfigFilePath);    IRuleConfigParserFactory parserFactory = RuleConfigParserFactoryMap.getParserFactory(ruleConfigFileExtension);    if (parserFactory == null) {      throw new InvalidRuleConfigException("Rule config file format is not supported: " + ruleConfigFilePath);    }    IRuleConfigParser parser = parserFactory.createParser();    String configText = "";    //ä»ruleConfigFilePathæ–‡ä»¶ä¸­è¯»å–é…ç½®æ–‡æœ¬åˆ°configTextä¸­    RuleConfig ruleConfig = parser.parse(configText);    return ruleConfig;  }  private String getFileExtension(String filePath) {    //...è§£ææ–‡ä»¶åè·å–æ‰©å±•åï¼Œæ¯”å¦‚rule.jsonï¼Œè¿”å›json    return "json";  }}//å› ä¸ºå·¥å‚ç±»åªåŒ…å«æ–¹æ³•ï¼Œä¸åŒ…å«æˆå‘˜å˜é‡ï¼Œå®Œå…¨å¯ä»¥å¤ç”¨ï¼Œ//ä¸éœ€è¦æ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„å·¥å‚ç±»å¯¹è±¡ï¼Œæ‰€ä»¥ï¼Œç®€å•å·¥å‚æ¨¡å¼çš„ç¬¬äºŒç§å®ç°æ€è·¯æ›´åŠ åˆé€‚ã€‚public class RuleConfigParserFactoryMap { //å·¥å‚çš„å·¥å‚  private static final Map&lt;String, IRuleConfigParserFactory&gt; cachedFactories = new HashMap&lt;&gt;();  static {    cachedFactories.put("json", new JsonRuleConfigParserFactory());    cachedFactories.put("xml", new XmlRuleConfigParserFactory());    cachedFactories.put("yaml", new YamlRuleConfigParserFactory());    cachedFactories.put("properties", new PropertiesRuleConfigParserFactory());  }  public static IRuleConfigParserFactory getParserFactory(String type) {    if (type == null || type.isEmpty()) {      return null;    }    IRuleConfigParserFactory parserFactory = cachedFactories.get(type.toLowerCase());    return parserFactory;  }}</code></pre><p>ä½†å…¶å®çœ‹èµ·æ¥ï¼Œä¹Ÿæ²¡æœ‰å¤ªå¤§çš„å¿…è¦å¤šåŠ IRuleConfigParserFactoryè¿™ä¸€å±‚ï¼Œåªç¼“å­˜æ–‡ä»¶ç±»å‹å’Œå¯¹åº”çš„è§£æç±»ä¹Ÿè¡Œï¼Œä½†æ˜¯è¿™æ®µä»£ç ï¼Œå¦‚æœéœ€è¦æ–°å¢è§£æç±»ï¼Œé‚£ä¹ˆå®Œå…¨ä¸ç”¨ä¿®æ”¹è°ƒç”¨çš„åœ°æ–¹ï¼Œåªéœ€è¦ä¿®æ”¹RuleConfigParserFactoryMapå°±è¡Œäº†ï¼Œå¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼Œå±è”½äº†æœåŠ¡ç«¯çš„å˜åŒ–</p><h3 id="ï¼ˆ3ï¼‰æŠ½è±¡å·¥å‚ï¼ˆä¸é‡è¦ï¼‰"><a href="#ï¼ˆ3ï¼‰æŠ½è±¡å·¥å‚ï¼ˆä¸é‡è¦ï¼‰" class="headerlink" title="ï¼ˆ3ï¼‰æŠ½è±¡å·¥å‚ï¼ˆä¸é‡è¦ï¼‰"></a>ï¼ˆ3ï¼‰æŠ½è±¡å·¥å‚ï¼ˆä¸é‡è¦ï¼‰</h3><p>åœ¨ç®€å•å·¥å‚å’Œå·¥å‚æ–¹æ³•ä¸­ï¼Œç±»åªæœ‰ä¸€ä¸ªåˆ†ç±»æ–¹å¼ã€‚æ¯”å¦‚åœ¨è§„åˆ™é…ç½®è§£æçš„ä¾‹å­ä¸­ï¼Œè§£æç±»åªä¼šæ ¹æ®é…ç½®æ–‡ä»¶æ ¼å¼æ¥åˆ†ç±»ï¼Œä½†æ˜¯å¦‚æœç±»æœ‰ä¸¤ç§åˆ†ç±»æ–¹å¼ï¼Œæ¯”å¦‚æ—¢å¯ä»¥æŒ‰ç…§é…ç½®æ–‡ä»¶æ ¼å¼æ¥åˆ†ç±»ï¼Œä¹Ÿå¯ä»¥æŒ‰ç…§è§£æçš„å¯¹è±¡æ¥åˆ†ç±»ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰8ä¸ªparserç±»ï¼Œå†å¤šå°±ç»„åˆçˆ†ç‚¸ï¼š</p><pre><code>é’ˆå¯¹è§„åˆ™é…ç½®çš„è§£æå™¨ï¼šåŸºäºæ¥å£IRuleConfigParserJsonRuleConfigParserXmlRuleConfigParserYamlRuleConfigParserPropertiesRuleConfigParseré’ˆå¯¹ç³»ç»Ÿé…ç½®çš„è§£æå™¨ï¼šåŸºäºæ¥å£ISystemConfigParserJsonSystemConfigParserXmlSystemConfigParserYamlSystemConfigParserPropertiesSystemConfigParser</code></pre><p>é’ˆå¯¹è¿™ç§åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥è®©ä¸€ä¸ªå·¥å‚è´Ÿè´£åˆ›å»ºå¤šä¸ªä¸é€šè¿‡çš„ç±»å‹çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯åªä¼šåˆ›å»ºä¸€ç§parserï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code>public interface IConfigParserFactory {  IRuleConfigParser createRuleParser();  ISystemConfigParser createSystemParser();  //æ­¤å¤„å¯ä»¥æ‰©å±•æ–°çš„parserç±»å‹ï¼Œæ¯”å¦‚IBizConfigParser}public class JsonConfigParserFactory implements IConfigParserFactory {  @Override  public IRuleConfigParser createRuleParser() {    return new JsonRuleConfigParser();  }  @Override  public ISystemConfigParser createSystemParser() {    return new JsonSystemConfigParser();  }}public class XmlConfigParserFactory implements IConfigParserFactory {  @Override  public IRuleConfigParser createRuleParser() {    return new XmlRuleConfigParser();  }  @Override  public ISystemConfigParser createSystemParser() {    return new XmlSystemConfigParser();  }}// çœç•¥YamlConfigParserFactoryå’ŒPropertiesConfigParserFactoryä»£ç </code></pre><p>æ›´åŠ é€šç”¨çš„æ–¹å¼å°±æ˜¯æ›´åŠ æŠ½è±¡ï¼</p><h2 id="3ã€å»ºé€ è€…æ¨¡å¼"><a href="#3ã€å»ºé€ è€…æ¨¡å¼" class="headerlink" title="3ã€å»ºé€ è€…æ¨¡å¼"></a>3ã€å»ºé€ è€…æ¨¡å¼</h2><p>Builderæ¨¡å¼ï¼Œä¸­æ–‡ç¿»è¯‘ä¸ºå»ºé€ è€…æ¨¡å¼æˆ–è€…æ„å»ºè€…æ¨¡å¼ï¼Œç”Ÿæˆå™¨æ¨¡å¼ï¼ŒåŸç†éå¸¸ç®€å•ã€‚</p><p>ç°åœ¨æœ‰ä¸€ä¸ªå¤æ‚çš„å¯¹è±¡éœ€è¦åˆ›å»ºï¼Œå¯¹è±¡çš„å±æ€§æœ‰å‡ åä¸ªï¼Œå¦‚æœæŒ‰ç…§æˆ‘ä»¬ä¼ ç»Ÿçš„setæ–¹å¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦åœ¨newå‡ºæ¥ä¸€ä¸ªå¯¹è±¡ä¹‹åï¼Œå†™åå‡ ä¸ªsetæ–¹æ³•æˆ–è€…å†™ä¸€ä¸ªå‚æ•°ç©¶æé•¿çš„æ„é€ å‡½æ•°ï¼Œæœ‰ä»¥ä¸‹ç¼ºç‚¹ï¼š</p><ul><li>å‚æ•°å¤ªé•¿ï¼Œå¯¹äºä¸€äº›ä¸å¿…å¡«çš„å‚æ•°ï¼Œéœ€è¦ç”¨nullæ¥å ä½</li><li>å¦‚æœå‚æ•°æœ‰ä¾èµ–å…³ç³»ï¼Œæ¯”å¦‚è®¾ç½®äº†ä¸€ä¸ªå°±å¿…é¡»è®¾ç½®å¦ä¸€ä¸ªï¼Œå¦‚ä½•å¤„ç†ï¼Ÿ</li><li>å¦‚æœæˆ‘ä»¬å¸Œæœ›è¿™ä¸ªç±»ä¸ºä¸å¯å˜å¯¹è±¡ï¼Œå³åˆ›å»ºå®Œå°±ä¸èƒ½å†è¢«ä¿®æ”¹ï¼Œnameæˆ‘ä»¬å°±ä¸èƒ½æš´éœ²setæ–¹æ³•ã€‚è¯¥å¦‚ä½•å¤„ç†</li></ul><p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæ„å»ºè€…æ¨¡å¼å°±æ’ä¸Šç”¨åœºäº†ã€‚æˆ‘ä»¬å°†æ ¡éªŒé€»è¾‘æ”¾åˆ°Builerç±»ä¸­ï¼Œå…ˆåˆ›å»ºå»ºé€ å’Œï¼Œå¹¶ä¸”é€šè¿‡setæ–¹æ³•è®¾ç½®å»ºé€ è€…çš„å˜é‡å€¼ï¼Œç„¶ååœ¨ä½¿ç”¨buildæ–¹æ³•çœŸæ­£åˆ›å»ºå¯¹è±¡ä¹‹å‰ï¼Œåšé›†ä¸­çš„æ ¡éªŒï¼Œå°†ç›®æ ‡å¯¹è±¡çš„æ„é€ æ–¹æ³•è®¾ç½®ä¸ºç§æœ‰ï¼Œå¹¶ä¸”ä¸æä¾›setæ–¹æ³•ï¼Œä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><pre><code>public class ResourcePoolConfig {  private String name;  private int maxTotal;  private int maxIdle;  private int minIdle;  private ResourcePoolConfig(Builder builder) {    this.name = builder.name;    this.maxTotal = builder.maxTotal;    this.maxIdle = builder.maxIdle;    this.minIdle = builder.minIdle;  }  //...çœç•¥getteræ–¹æ³•...  //æˆ‘ä»¬å°†Builderç±»è®¾è®¡æˆäº†ResourcePoolConfigçš„å†…éƒ¨ç±»ã€‚  //æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†Builderç±»è®¾è®¡æˆç‹¬ç«‹çš„éå†…éƒ¨ç±»ResourcePoolConfigBuilderã€‚  public static class Builder {    private static final int DEFAULT_MAX_TOTAL = 8;    private static final int DEFAULT_MAX_IDLE = 8;    private static final int DEFAULT_MIN_IDLE = 0;    private String name;    private int maxTotal = DEFAULT_MAX_TOTAL;    private int maxIdle = DEFAULT_MAX_IDLE;    private int minIdle = DEFAULT_MIN_IDLE;    public ResourcePoolConfig build() {      // æ ¡éªŒé€»è¾‘æ”¾åˆ°è¿™é‡Œæ¥åšï¼ŒåŒ…æ‹¬å¿…å¡«é¡¹æ ¡éªŒã€ä¾èµ–å…³ç³»æ ¡éªŒã€çº¦æŸæ¡ä»¶æ ¡éªŒç­‰      if (StringUtils.isBlank(name)) {        throw new IllegalArgumentException("...");      }      if (maxIdle &gt; maxTotal) {        throw new IllegalArgumentException("...");      }      if (minIdle &gt; maxTotal || minIdle &gt; maxIdle) {        throw new IllegalArgumentException("...");      }      return new ResourcePoolConfig(this);    }    public Builder setName(String name) {      if (StringUtils.isBlank(name)) {        throw new IllegalArgumentException("...");      }      this.name = name;      return this;    }    public Builder setMaxTotal(int maxTotal) {      if (maxTotal &lt;= 0) {        throw new IllegalArgumentException("...");      }      this.maxTotal = maxTotal;      return this;    }    public Builder setMaxIdle(int maxIdle) {      if (maxIdle &lt; 0) {        throw new IllegalArgumentException("...");      }      this.maxIdle = maxIdle;      return this;    }    public Builder setMinIdle(int minIdle) {      if (minIdle &lt; 0) {        throw new IllegalArgumentException("...");      }      this.minIdle = minIdle;      return this;    }  }}// è¿™æ®µä»£ç ä¼šæŠ›å‡ºIllegalArgumentExceptionï¼Œå› ä¸ºminIdle&gt;maxIdleResourcePoolConfig config = new ResourcePoolConfig.Builder()        .setName("dbconnectionpool")        .setMaxTotal(16)        .setMaxIdle(10)        .setMinIdle(12)        .build();</code></pre><p>ä¸å·¥å‚æ¨¡å¼æœ‰ä½•åŒºåˆ«ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå»ºé€ è€…æ¨¡å¼æ˜¯è®©å»ºé€ è€…ç±»æ¥è´Ÿè´£å¯¹è±¡çš„åˆ›å»ºå·¥ä½œï¼Œè€Œå·¥å‚æ¨¡å¼æ˜¯è®©å·¥å‚ç±»æ¥è´Ÿè´£åˆ›å»ºçš„å·¥ä½œã€‚</p><p>åŒºåˆ«åœ¨äºï¼šå·¥å‚æ¨¡å¼å¸‚åˆ›å»ºä¸åŒä½†æ˜¯ç›¸å…³ç±»å‹çš„å¯¹è±¡ï¼Œç”±ç»™å®šçš„å‚æ•°æ¥å†³å®šåˆ›å»ºé‚£ç§ç±»å‹çš„å¯¹è±¡ï¼›è€Œå»ºé€ è€…æ¨¡å¼æ˜¯ç”¨æ¥åˆ›å»ºä¸€ç§ç±»å‹çš„å¤æ‚å¯¹è±¡ï¼Œé€šè¿‡è®¾ç½®ä¸åŒçš„å¯é€‰å‚æ•°ï¼Œå®šåˆ¶åŒ–ä¸åŒçš„å¤æ‚å¯¹è±¡</p><p>ç½‘ä¸Šæœ‰ä¸€ä¸ªç»å…¸ä¾‹å­ï¼š</p><p>é¡¾å®¢èµ°è¿›ä¸€å®¶é¤é¦†ç‚¹é¤ï¼Œæˆ‘ä»¬åˆ©ç”¨å·¥å‚æ¨¡å¼ï¼Œæ ¹æ®ç”¨æˆ·ä¸åŒçš„é€‰æ‹©ï¼Œæ¥åˆ¶ä½œä¸åŒçš„é£Ÿç‰©ï¼Œæ¯”å¦‚æŠ«è¨ã€æ±‰å ¡ã€æ²™æ‹‰ã€‚å¯¹äºæŠ«è¨æ¥è¯´ï¼Œç”¨æˆ·åˆæœ‰å„ç§é…æ–™å¯ä»¥å®šåˆ¶ï¼Œæ¯”å¦‚å¥¶é…ªã€è¥¿çº¢æŸ¿ã€èµ·å¸ï¼Œæˆ‘ä»¬é€šè¿‡å»ºé€ è€…æ¨¡å¼æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„ä¸åŒé…æ–™æ¥åˆ¶ä½œæŠ«è¨ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬ä¹Ÿä¸è¦å¤ªå­¦é™¢æ´¾ï¼Œéå¾—æŠŠå·¥å‚æ¨¡å¼ã€å»ºé€ è€…æ¨¡å¼åˆ†å¾—é‚£ä¹ˆæ¸…æ¥šï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œæ¯ä¸ªæ¨¡å¼ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Œèƒ½è§£å†³ä»€ä¹ˆé—®é¢˜ã€‚åªæœ‰äº†è§£äº†è¿™äº›æœ€æœ¬è´¨çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬æ‰èƒ½ä¸ç”Ÿæ¬ç¡¬å¥—ï¼Œæ‰èƒ½çµæ´»åº”ç”¨ï¼Œç”šè‡³å¯ä»¥æ··ç”¨å„ç§æ¨¡å¼åˆ›é€ å‡ºæ–°çš„æ¨¡å¼ï¼Œæ¥è§£å†³ç‰¹å®šåœºæ™¯çš„é—®é¢˜ã€‚</p><h2 id="4ã€åŸå‹æ¨¡å¼"><a href="#4ã€åŸå‹æ¨¡å¼" class="headerlink" title="4ã€åŸå‹æ¨¡å¼"></a>4ã€åŸå‹æ¨¡å¼</h2><p>å¦‚æœå¯¹è±¡çš„åˆ›å»ºæˆæœ¬æ¯”è¾ƒå¤§ï¼Œè€ŒåŒä¸€ä¸ªç±»çš„ä¸åŒå¯¹è±¡ä¹‹é—´å·®åˆ«ä¸å¤§ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¯¹å·²æœ‰å¯¹è±¡è¿›è¡Œå¤åˆ¶çš„æ–¹å¼æ¥åˆ›å»ºæ–°å¯¹è±¡ï¼Œä»¥è¾¾åˆ°èŠ‚çœåˆ›å»ºæ—¶é—´çš„æ‘¸åº•ï¼Œè¿™ç§åŸºäºåŸå‹æ¥åˆ›å»ºå¯¹è±¡çš„æ–¹å¼å«åšåŸå‹è®¾è®¡æ¨¡å¼</p><p>é‚£æ€ä¹ˆæ ·æ‰èƒ½å«åšâ€œå¯¹è±¡çš„åˆ›å»ºæˆæœ¬æ¯”è¾ƒå¤§â€ï¼Ÿ</p><p>å®é™…ä¸Šï¼Œå¯¹è±¡åˆ›å»ºæ—¶ç”³è¯·å†…å­˜ï¼Œç»™å±æ€§èµ‹å€¼çš„è€—æ—¶å¹¶ä¸ä¼šå¤ªå¤§ï¼Œæˆ–è€…å¯¹äºå¤§éƒ¨åˆ†ä¸šåŠ¡ç³»ç»Ÿæ¥è¯´ï¼Œè¿™ç‚¹æ—¶é—´å®Œå…¨æ˜¯å¯ä»¥å¿½ç•¥çš„ï¼Œä¸ºäº†ä¸€ç‚¹ç‚¹çš„æ€§èƒ½æå‡å»åº”ç”¨ä¸€ä¸ªå¤æ‚çš„è®¾è®¡æ¨¡å¼ï¼Œæ˜¯å¾—ä¸å¿å¤±çš„ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœå¯¹è±¡çš„è·å¾—éœ€è¦ç»è¿‡å¤æ‚çš„è®¡ç®—æ‰èƒ½å¾—åˆ°ï¼Œæ¯”å¦‚å“ˆå¸Œï¼Œæ’åºï¼Œæˆ–è€…éœ€è¦ä»RPCï¼Œç½‘ç»œï¼Œæ•°æ®åº“æˆ–è€…æ–‡ä»¶ç­‰éå¸¸æ…¢çš„IOè¯»å–ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨åŸå‹æ¨¡å¼ï¼Œä»å…¶ä»–å¯¹è±¡ä¸­ç›´æ¥æ‹·è´ï¼Œè€Œä¸ç”¨æ¯æ¬¡åœ¨åˆ›å»ºæ–°å¯¹è±¡çš„æ—¶å€™ï¼Œéƒ½é‡å¤æ‰§è¡Œè¿™äº›è€—æ—¶çš„æ“ä½œã€‚</p><p>å®ç°æ–¹å¼ï¼š<strong>æ·±æ‹·è´å’Œæµ…æ‹·è´</strong></p><p><strong>æµ…æ‹·è´</strong>ï¼šæµ…æ‹·è´åªä¼šå¤åˆ¶å¯¹è±¡ä¸­çš„å¼•ç”¨ï¼Œå³å¤åˆ¶äº†ä¸€ä¸‹åœ°å€ï¼Œå°†å¤åˆ¶å‡ºæ¥çš„å¯¹è±¡æŒ‡å‘åŸå¯¹è±¡çš„åœ°å€ã€‚æµ…æ‹·è´å‡ºæ¥çš„å¯¹è±¡è·Ÿæºå¯¹è±¡éƒ½æŒ‡å‘åŒä¸€å—å†…å­˜åŒºåŸŸã€‚æµ…æ‹·è´åªä¼šæ‹·è´å¯¹è±¡ä¸­çš„åŸºæœ¬æ•°æ®ç±»å‹çš„æ•°æ®å’Œå¼•ç”¨å¯¹è±¡çš„å†…å­˜åœ°å€ï¼Œä¸ä¼šé€’å½’çš„æ‹·è´å¼•ç”¨å¯¹è±¡æœ¬èº«</p><p><strong>æ·±æ‹·è´</strong>ï¼šæ·±æ‹·è´æ˜¯å¾—åˆ°ä¸€ä»½å®Œå…¨ç‹¬ç«‹çš„å¯¹è±¡ï¼Œå¦ç”³è¯·ä¸€å—å†…å­˜å­˜å‚¨è¿™äº›æ•°æ®ï¼Œä¼šé€’å½’çš„æ‹·è´å¼•ç”¨å¯¹çº¿è·Ÿæœ¬èº«ã€‚æ·±æ‹·è´çš„å®ç°æ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯é€’å½’çš„æ‹·è´å¼•ç”¨å¯¹è±¡ï¼Œä¸€ç§æ˜¯å°†æºå¯¹è±¡åºåˆ—åŒ–ï¼Œåœ¨ååºåˆ—åŒ–æˆä¸€ä¸ªæ–°å¯¹è±¡ã€‚</p><p><a href="https://imgchr.com/i/BtFPG6"><img src="https://s1.ax1x.com/2020/10/30/BtFPG6.md.jpg" alt="BtFPG6.md.jpg"></a></p><p><em>è®¾è®¡æ¨¡å¼ç³»åˆ—éƒ½æ˜¯æå®¢æ—¶é—´å­¦ä¹ ç•¥ä½œæ€»ç»“ï¼ŒåŸè¯¾ç¨‹å¯ä»¥</em><a href="https://time.geekbang.org/column/intro/250?utm_campaign=guanwang&amp;utm_source=baidu-ad&amp;utm_medium=ppzq-pc&amp;utm_content=title&amp;utm_term=baidu-ad-ppzq-title"><em>ç‚¹å‡»</em></a><em>è´­ä¹°</em></p>]]></content>
      
      
      <categories>
          
          <category> ç¼–ç ä¸è®¾è®¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•ä½¿ç”¨SQLçš„EXPLAINæŒ‡ä»¤åˆ¤æ–­å’Œä¼˜åŒ–SQLæ€§èƒ½ï¼Ÿ</title>
      <link href="2020/10/29/EXPALIN/"/>
      <url>2020/10/29/EXPALIN/</url>
      
        <content type="html"><![CDATA[<p>å·¥ä½œä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šå†™ä¸€äº›å¾ˆå¤æ‚çš„SQLï¼Œæœ‰å¯èƒ½æ˜¯ç»Ÿè®¡æŠ¥è¡¨ï¼Œæœ‰å¯èƒ½æ˜¯å¤æ‚æŸ¥è¯¢ï¼Œå½“æˆ‘ä»¬è´¹å°½æ‰‹æ®µæŠŠä¸€ä¸ªå¯ä»¥å·¥ä½œçš„SQLå†™å‡ºæ¥ä¹‹åï¼Œå¹¶ä¸æ„å‘³ç€ç»“æŸäº†ï¼Œå¦‚æœè¿™ä¸ªSQLæŸ¥è¯¢æˆ–è€…ç»Ÿè®¡é€Ÿåº¦å¾ˆæ…¢ï¼Œå°†æ˜¯ä¸€ä¸ªååˆ†è€—è´¹èµ„æºçš„åŠ¨ä½œã€‚å³ä½¿å®ƒèƒ½å·¥ä½œï¼Œä¹Ÿæœ‰å¯èƒ½åœ¨æ‰§è¡ŒåŠåˆ†é’Ÿæˆ–è€…æ›´ä¹…ä¹‹åèƒ½å¤Ÿç»™å‡ºç»“æœï¼Œä½†æ‰§è¡Œæ—¶é—´è¶Šä¹…ï¼Œè€—è´¹èµ„æºå°±è¶Šå¤šï¼Œè¶Šå®¹æ˜“é˜»å¡åç»­çš„æ•°æ®åº“é“¾æ¥è¯·æ±‚ï¼Œå¦‚æœè¿™æ ·çš„SQLå¾ˆå¤šï¼Œé‚£ä¹ˆæœ€ç»ˆä¹Ÿå°†æ‹–å®æœåŠ¡å™¨ã€‚</p><h3 id="EXPALINæŒ‡ä»¤"><a href="#EXPALINæŒ‡ä»¤" class="headerlink" title="EXPALINæŒ‡ä»¤"></a>EXPALINæŒ‡ä»¤</h3><p>SQLä¸ºä»€ä¹ˆä¼šæ‰§è¡Œçš„æ…¢ï¼Ÿè¯¥å¦‚ä½•åˆ¤æ–­è¿™ä¸ªSQLçš„æŸ¥è¯¢æ•°é‡çº§ï¼Ÿæˆ‘ä»¬å¯ä»¥ç”¨ â€œEXPLAINâ€æŒ‡ä»¤ï¼Œè§£é‡Šä½ çš„SQLã€‚</p><p>EXPLAINæŒ‡ä»¤æ˜¯ä¸€ä¸ªä¼˜åŒ–ç¥å™¨ï¼Œè™½ç„¶å®ƒå¹¶ä¸èƒ½ç›´æ¥å‘Šè¯‰ä½ è¯¥å¦‚ä½•ä¼˜åŒ–è¿™ä¸ªSQLï¼Œä½†æ˜¯ä½ å¯ä»¥æ ¹æ®å®ƒå¯¹ä½ SQLçš„æ¨¡æ‹Ÿæ‰§è¡Œå¾—åˆ°ä½ çš„SQLæœ‰æ²¡æœ‰ç”¨ä¸Šç´¢å¼•ï¼Œæœ‰æ²¡æœ‰åšå…¨è¡¨æ‰«æï¼ŒæŸ¥è¯¢å‡ºç»“æœçš„æ•°é‡çº§æ˜¯å¤šå°‘ã€‚è¿™æ˜¯ä¸€ä¸ªåŸºäºå¼€é”€çš„ä¼˜åŒ–å™¨ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—æ›´å¤šè¢«ä¼˜åŒ–å™¨è€ƒè™‘åˆ°çš„è®¿é—®ç­–ç•¥çš„ç»†èŠ‚ï¼Œä»¥åŠå½“è¿è¡ŒSQLè¯­å¥æ—¶ï¼Œå“ªç§ç­–ç•¥é¢„è®¡ä¼šè¢«é‡‡ç”¨ã€‚</p><pre><code>mysql&gt; explain select * from servers;+----+-------------+---------+------+---------------+------+---------+------+------+-------+| id | select_type | table   | type | possible_keys | key  | key_len | ref  | rows | Extra |+----+-------------+---------+------+---------------+------+---------+------+------+-------+|  1 | SIMPLE      | servers | ALL  | NULL          | NULL | NULL    | NULL |    1 | NULL  |+----+-------------+---------+------+---------------+------+---------+------+------+-------+row in set (0.03 sec)</code></pre><p>æˆ‘ä»¬åšäº†ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°explainçš„ç”¨æ³•å°±æ˜¯ â€œexplain ç›®æ ‡SQLâ€ï¼Œå¾—å‡ºçš„ç»“æœæœ‰10åˆ—ï¼Œå¦‚ä¸Šä»£ç å—ï¼Œæˆ‘ä»¬ä¼šæŒ¨ä¸ªè§£é‡Šè¿™äº›åˆ—çš„æ„ä¹‰ã€‚</p><h4 id="1ã€id"><a href="#1ã€id" class="headerlink" title="1ã€id"></a>1ã€id</h4><p>è¿™ä¸ªidå¹¶ä¸æ˜¯è¡¨ä¸­è®°å½•çš„idï¼Œè€Œæ˜¯æŸ¥è¯¢è¯­å¥æˆ–è€…æ“ä½œè¡¨çš„é¡ºåºï¼ŒåŒ…å«å‡ ç§æƒ…å†µ</p><p>idç›¸åŒæ—¶ï¼Œæ‰§è¡Œé¡ºåºç”±ä¸Šåˆ°ä¸‹</p><p>idä¸åŒï¼Œå¦‚æœæ˜¯å­æŸ¥è¯¢ï¼Œidåºå·ä¼šé€’å¢ï¼Œidè¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆè¢«æ‰§è¡Œ</p><p>idæ—¢æœ‰ç›¸åŒçš„ï¼Œä¹Ÿæœ‰ä¸åŒçš„ã€‚idç›¸åŒçš„è¢«è®¤ä¸ºæ˜¯ä¸€ç»„ï¼Œé¡ºåºä»ä¸Šåˆ°ä¸‹ï¼›åœ¨æ‰€æœ‰ç»„ä¸­ï¼Œidè¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ã€‚</p><h4 id="2ã€select-type"><a href="#2ã€select-type" class="headerlink" title="2ã€select type"></a>2ã€select type</h4><p>è¡¨ç¤ºæŸ¥è¯¢ä¸­æ¯ä¸ªselectå­—å¥çš„ç±»å‹</p><p>ï¼ˆ1ï¼‰simpleï¼šç®€å•selectï¼Œä¸ä½¿ç”¨unionæˆ–å­æŸ¥è¯¢ç­‰</p><p>ï¼ˆ2ï¼‰primaryï¼šæŸ¥è¯¢ä¸­è‹¥åŒ…å«ä»»ä½•å¤æ‚çš„å­éƒ¨åˆ†ï¼Œæœ€å¤–å±‚çš„selectä¼šè¢«æ ‡è®°ä¸ºprimary</p><p>ï¼ˆ3ï¼‰unionï¼šunionä¸­çš„ç¬¬äºŒä¸ªæˆ–è€…åè¾¹çš„selectè¯­å¥</p><p>ï¼ˆ4ï¼‰subqueryï¼šåœ¨selectæˆ–è€…whereä¸­åŒ…å«äº†å­æŸ¥è¯¢</p><p>ï¼ˆ5ï¼‰derivedï¼šåœ¨fromåˆ—è¡¨ä¸­åŒ…å«çš„å­æŸ¥è¯¢è¢«æ ‡è®°ä¸ºderivedï¼ˆè¡ç”Ÿè¡¨ï¼‰ï¼Œmysqlä¼šé€’å½’è¿™äº›å­æŸ¥è¯¢å¹¶æ”¾åˆ°ä¸´æ—¶è¡¨ä¸­</p><p>ï¼ˆ6ï¼‰union result:ä»unionè¡¨ä¸­è·å–selectæŸ¥è¯¢çš„ç»“æœ</p><h4 id="3ã€table"><a href="#3ã€table" class="headerlink" title="3ã€table"></a>3ã€table</h4><p>æ ‡è¯†è¿™ä¸€è¡Œçš„æ•°æ®æ˜¯å…³äºå“ªä¸€å¼ è¡¨çš„ï¼Œæœ‰çš„æ—¶å€™å¹¶ä¸æ˜¯çœŸå®çš„è¡¨åï¼Œæ¯”å¦‚æ˜¯derivedè¡ç”Ÿè¡¨</p><pre><code>mysql&gt; explain select * from (select * from ( select * from t1 where id=2602) a) b;+----+-------------+------------+--------+-------------------+---------+---------+------+------+-------+| id | select_type | table      | type   | possible_keys     | key     | key_len | ref  | rows | Extra |+----+-------------+------------+--------+-------------------+---------+---------+------+------+-------+|  1 | PRIMARY     | &lt;derived2&gt; | system | NULL              | NULL    | NULL    | NULL |    1 |       ||  2 | DERIVED     | &lt;derived3&gt; | system | NULL              | NULL    | NULL    | NULL |    1 |       ||  3 | DERIVED     | t1         | const  | PRIMARY,idx_t1_id | PRIMARY | 4       |      |    1 |       |+----+-------------+------------+--------+-------------------+---------+---------+------+------+-------+</code></pre><h4 id="4ã€type"><a href="#4ã€type" class="headerlink" title="4ã€type"></a>4ã€type</h4><p>è¡¨ç¤ºåœ¨è¡¨ä¸­æ‰¾åˆ°æ‰€éœ€è¡Œçš„æ–¹å¼ï¼Œåˆå«åšè®¿é—®ç±»å‹ã€‚å¸¸ç”¨çš„ç±»å‹ç”±ï¼šallï¼Œindexï¼Œrangeï¼Œrefï¼Œeq_refï¼Œconstï¼Œsystemï¼Œnullï¼ˆæ€§èƒ½ä»å·®åˆ°å¥½ï¼‰</p><p>all:ï¼šå…¨è¡¨æ‰«æ</p><p>indexï¼šindexå’Œallçš„åŒºåˆ«æ˜¯indexåªéå†ç´¢å¼•æ ‘</p><p>rangeï¼šåªæ£€ç´¢ç»™å®šèŒƒå›´çš„è¡Œè®°å½•ï¼Œä½¿ç”¨ä¸€ä¸ªç´¢å¼•æ¥é€‰æ‹©è¡Œ</p><p>refï¼šè¡¨ç¤ºä¸Šè¿°è¡¨çš„è¿æ¥åŒ¹é…æ¡ä»¶ï¼Œå³å“ªäº›åˆ—æˆ–å¸¸é‡è¢«ç”¨äºæŸ¥æ‰¾ç´¢å¼•åˆ—ä¸Šçš„å€¼</p><p>eq_refï¼šè·Ÿrefç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºä½¿ç”¨çš„ç´¢å¼•æ˜¯å”¯ä¸€ç´¢å¼•</p><p>sonstï¼Œsystemï¼šå½“SQLå¯¹æŸ¥è¯¢éƒ¨åˆ†è¿›è¡Œä¼˜åŒ–ï¼Œå¹¶è½¬æ¢ä¸ºä¸€ä¸ªå¸¸é‡æ—¶ï¼Œä½¿ç”¨è¿™äº›ç±»å‹è®¿é—®ã€‚</p><p>nullï¼šåœ¨ä¼˜åŒ–è¿‡ç¨‹ä¸­åˆ†è§£è¯­å¥ï¼Œæ‰§è¡Œæ—¶ç”šè‡³ä¸ç”¨è®¿é—®è¡¨æˆ–è€…ç´¢å¼•ã€‚ä¾‹å¦‚ä»ä¸€ä¸ªç´¢å¼•åˆ—ä¸­é€‰å–æœ€å°å€¼å¯ä»¥å•ç‹¬é€šè¿‡ç´¢å¼•æŸ¥æ‰¾å®Œæˆã€‚</p><h4 id="5ã€possible-keys"><a href="#5ã€possible-keys" class="headerlink" title="5ã€possible_keys"></a>5ã€possible_keys</h4><p>æŒ‡å‡ºèƒ½ä½¿ç”¨å“ªä¸ªç´¢å¼•åœ¨è¡¨ä¸­æ‰¾åˆ°è®°å½•ï¼ŒæŸ¥è¯¢æ¶‰åŠçš„å­—æ®µè‹¥å­˜åœ¨ç´¢å¼•ï¼Œä¼šåœ¨è¿™ä¸€åˆ—åˆ—å‡ºæ¥ï¼Œä½†ä¸ä¸€å®šä¼šç”¨åˆ°è¯¥ç´¢å¼•ã€‚</p><p>å¦‚æœè¯¥åˆ—æ˜¯nullï¼Œå°±è¯´æ˜æ²¡æœ‰ç”¨åˆ°ä»»ä½•ç´¢å¼•ï¼Œè¿™æ—¶å€™ä½ å¯èƒ½éœ€è¦è§‚å¯Ÿè¡¨ä¸­çš„æŸ¥è¯¢é«˜é¢‘åˆ—å¢åŠ ç´¢å¼•ï¼Œç„¶ååœ¨explainçœ‹ä¸‹ç»“æœ</p><h4 id="6ã€keys"><a href="#6ã€keys" class="headerlink" title="6ã€keys"></a>6ã€keys</h4><p>æ˜¾ç¤ºå®é™…å†³å®šä½¿ç”¨çš„ç´¢å¼•åˆ—</p><p>å¦‚æœæ²¡æœ‰é€‰æ‹©åˆ°ç´¢å¼•ï¼Œåˆ™æ˜¯nullã€‚å¦‚æœè¦å¼ºåˆ¶ä½¿ç”¨æŸä¸ªç´¢å¼•ï¼Œéœ€è¦åœ¨æŸ¥è¯¢ä¸­åŠ è¯­å¥ï¼šforce indexï¼Œuse indexã€‚å¦‚æœä¸æƒ³ä½¿ç”¨æŸç´¢å¼•ï¼Œå¯ä»¥ä½¿ç”¨ ignore index </p><h4 id="7ã€key-len"><a href="#7ã€key-len" class="headerlink" title="7ã€key_len"></a>7ã€key_len</h4><p>è¡¨ç¤ºç´¢å¼•ä¸­ä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œå¯ä»¥é€šè¿‡è¯¥åˆ—è®¡ç®—æŸ¥è¯¢ä¸­ä½¿ç”¨çš„ç´¢å¼•é•¿åº¦</p><h4 id="8ã€ref"><a href="#8ã€ref" class="headerlink" title="8ã€ref"></a>8ã€ref</h4><p>è¡¨ç¤ºä¸Šè¿°è¡¨çš„è¿æ¥åŒ¹é…æ¡ä»¶ï¼Œå³å“ªäº›åˆ—æˆ–å¸¸é‡è¢«ç”¨äºæŸ¥æ‰¾ç´¢å¼•åˆ—ä¸Šçš„å€¼ã€‚</p><h4 id="9ã€rows"><a href="#9ã€rows" class="headerlink" title="9ã€rows"></a>9ã€rows</h4><p>æ ‡è¯†æ­¤æ¬¡æŸ¥è¯¢æ ¹æ®è¡¨ç»Ÿè®¡ä¿¡æ¯åŠç´¢å¼•é€‰ç”¨æƒ…å†µï¼Œä¼°ç®—åˆ°çš„æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®°å½•æ‰€éœ€è¦è¯»å–çš„è¡Œæ•°</p><h4 id="10ã€extra"><a href="#10ã€extra" class="headerlink" title="10ã€extra"></a>10ã€extra</h4><p>åŒ…å«æ­¤æ¬¡æŸ¥è¯¢çš„è¯¦ç»†ä¿¡æ¯ï¼š</p><p>using filesortï¼šè¡¨æ˜æ­¤æ¬¡æŸ¥è¯¢ä¼šä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨çš„ç´¢å¼•æ’åºï¼Œè€Œä¸æ˜¯æŒ‰ç…§è¡¨å†…çš„ç´¢å¼•é¡ºåºè¿›è¡Œè¯»å–ã€‚æŸ¥è¯¢ä¸­æ— æ³•åˆ©ç”¨ç´¢å¼•å®Œæˆçš„æ’åºè¢«ç§°ä¸ºæ–‡ä»¶æ’åº</p><p>using temporaryï¼šæ­¤æ¬¡æŸ¥è¯¢ä½¿ç”¨åˆ°äº†ä¸´æ—¶è¡¨ä¿å­˜ä¸­é—´ç»“æœï¼Œå¸¸è§äºorder byå’Œgroup by</p><p>using indexï¼šè¡¨æ˜æ­¤æ¬¡æŸ¥è¯¢å®ç”¨åˆ°äº†è¦†ç›–ç´¢å¼•ï¼Œé¿å…äº†å…¨è¡¨æ‰«æ</p><p>using whereï¼šè¡¨æ˜æ­¤æ¬¡æŸ¥è¯¢whereçš„æ¡ä»¶é‡Œè¾¹ï¼Œæœ‰ç´¢å¼•å€¼å­˜åœ¨ï¼Œä½¿ç”¨åˆ°äº†ç´¢å¼•å»æŸ¥è¯¢</p><p>using join bufferï¼šä½¿ç”¨äº†é“¾æ¥ç¼“å­˜</p><p>impossible whereï¼šwhereæ¡ä»¶é‡Œè¾¹æ€»æ˜¯falseï¼Œä¸èƒ½ç”¨æ¥è·å–ä»»ä½•è®°å½•</p><p>select tables optimized awayï¼šè¿™æ„å‘³ç€ä»…é€šè¿‡ä½¿ç”¨ç´¢å¼•ï¼Œä¼˜åŒ–å™¨å¯èƒ½ä»…ä»èšåˆå‡½æ•°ä¸­è¿”å›ä¸€è¡Œ</p><p>explainæŒ‡ä»¤ï¼Œä¸ä¼šè€ƒè™‘å„ç§cacheï¼Œä¹Ÿä¸ä¼šå‘Šè¯‰ä½ å®ƒåšäº†ä»€ä¹ˆä¼˜åŒ–ï¼Œä¹Ÿåªèƒ½æ”¯æŒselectæ“ä½œï¼Œéƒ¨åˆ†çš„ç»Ÿè®¡ä¿¡æ¯æ˜¯ä¼°ç®—çš„ï¼Œå¹¶éç²¾ç¡®å€¼ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨explainçš„æ—¶å€™ï¼Œåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½æ˜¯è¦å…³æ³¨ï¼š<strong>possible_keysï¼Œ**</strong>Keyï¼Œ**<strong>rowsï¼Œ**</strong>Extra<strong>è¿™å››é¡¹ï¼Œå…³æ³¨æ­¤æ¬¡æŸ¥è¯¢</strong>æ˜¯å¦ç”¨åˆ°äº†ç´¢å¼•ï¼Œå¤§çº¦æŸ¥è¯¢çš„æ•°æ®åœ¨ä»€ä¹ˆé‡çº§ï¼Œé¢å¤–ç”¨åˆ°äº†å“ªäº›ä¸œè¥¿**ï¼Œè¿™æ˜¯æˆ‘ä»¬ç€é‡ä¼˜åŒ–çš„ç‚¹ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> ORACLE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®åº“äº‹åŠ¡éš”ç¦»çº§åˆ«</title>
      <link href="2020/10/29/data_transaction/"/>
      <url>2020/10/29/data_transaction/</url>
      
        <content type="html"><![CDATA[<h3 id="ä»€ä¹ˆæ˜¯äº‹åŠ¡éš”ç¦»ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯äº‹åŠ¡éš”ç¦»ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯äº‹åŠ¡éš”ç¦»ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯äº‹åŠ¡éš”ç¦»ï¼Ÿ</h3><p>ä»»ä½•æ”¯æŒäº‹åŠ¡çš„æ•°æ®åº“ï¼Œéƒ½å¿…é¡»å…·å¤‡å››ä¸ªç‰¹æ€§ï¼šåŸå­æ€§ï¼Œä¸€è‡´æ€§ï¼Œéš”ç¦»æ€§ï¼Œæ°¸ä¹…æ€§ï¼Œä¹Ÿå°±æ˜¯ACIDï¼Œè¿™æ ·æ‰èƒ½ä¿è¯äº‹åŠ¡ä¸­æ•°æ®çš„æ­£ç¡®æ€§ã€‚</p><p>è€Œäº‹åŠ¡çš„éš”ç¦»æ€§å°±æ˜¯æŒ‡ï¼šå¤šä¸ªå¹¶å‘çš„äº‹åŠ¡åŒäº‹è®¿é—®ä¸€ä¸ªæ•°æ®åº“æ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡ä¸åº”è¯¥è¢«å¦ä¸€ä¸ªäº‹åŠ¡æ‰€å¹²æ‰°ï¼Œæ¯ä¸ªå¹¶å‘çš„äº‹åŠ¡éƒ½è¦ç›¸äº’éš”ç¦»ã€‚</p><h3 id="å¦‚æœæ²¡æœ‰äº‹åŠ¡éš”ç¦»"><a href="#å¦‚æœæ²¡æœ‰äº‹åŠ¡éš”ç¦»" class="headerlink" title="å¦‚æœæ²¡æœ‰äº‹åŠ¡éš”ç¦»"></a>å¦‚æœæ²¡æœ‰äº‹åŠ¡éš”ç¦»</h3><p>å¦‚æœæ²¡æœ‰äº‹åŠ¡éš”ç¦»çš„è¯ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p><p>å‡è®¾æœ‰è¡¨Tï¼Œé‡Œè¾¹è®°å½•äº†å‡ ç§è¯­è¨€çš„è®°å½•</p><table><thead><tr><th>ID</th><th>NAME</th></tr></thead><tbody><tr><td>1</td><td>JavaWeb</td></tr><tr><td>2</td><td>Python</td></tr><tr><td>3</td><td>Go</td></tr></tbody></table><p>ï¼ˆ1ï¼‰äº‹åŠ¡Aè®¿é—®æ•°æ®åº“ï¼Œå‘è¡¨ä¸­æ’å…¥äº†ä¸€æ¡è®°å½•4:C++ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æäº¤äº‹åŠ¡</p><p>insert into T values(4,â€™C++â€™)ï¼›</p><p>è¿™æ—¶å€™ï¼Œæ¥äº†ä¸€ä¸ªäº‹åŠ¡Bï¼Œè¦æŸ¥è¯¢è¡¨ä¸­æ‰€æœ‰çš„è®°å½•ï¼Œè¿™æ˜¯å°±èƒ½æŸ¥åˆ°idä¸º4çš„C++ï¼Œè¿™ç§æƒ…å†µå«åšâ€œè„è¯»â€</p><p>ï¼ˆ2ï¼‰äº‹åŠ¡Aè®¿é—®æ•°æ®åº“ï¼Œè¦æŒ‰idæŸ¥è¯¢idä¸º1çš„è¯­è¨€çš„åå­—ï¼Œæ‰§è¡Œäº†ï¼š</p><pre><code>select * from T where id = 1;</code></pre><p>å¾—åˆ°äº†nameä¸ºJavaWebçš„è®°å½•ã€‚è¿™æ—¶å€™äº‹åŠ¡Bè®¿é—®æ•°æ®åº“ï¼Œå°†idä¸º1çš„è®°å½•çš„nameæ›´æ–°ä¸ºäº†JavaEE</p><pre><code>update T set name = 'JavaEE' where id = 1;</code></pre><p>æ¥ç€äº‹åŠ¡Aè¿˜æƒ³å†çœ‹ä¸€æ¬¡idä¸º1çš„è®°å½•çš„nameï¼Œå‘ç°å·²ç»å˜æˆäº†JavaEEï¼Œè·Ÿç¬¬ä¸€æ¬¡çš„è¯»å–æ•°æ®ä¸åŒï¼Œè¿™å°±å«åšä¸å¯é‡å¤è¯»ã€‚</p><p>ï¼ˆ3ï¼‰äº‹åŠ¡Aè®¿é—®æ•°æ®åº“ï¼Œæƒ³çœ‹è¡¨ä¸­çš„è®°å½•éƒ½æœ‰ä»€ä¹ˆï¼Œäºæ˜¯æ‰§è¡Œäº†ï¼š</p><pre><code>select * from T;</code></pre><p>è¿™æ—¶å€™ï¼Œäº‹åŠ¡Bæ¥äº†ï¼Œå‘è¡¨ä¸­æ’å…¥äº†ä¸€æ¡æ–°çš„è®°å½•ï¼š</p><pre><code>insert into A values(5,'SQL');</code></pre><p>ç„¶åäº‹åŠ¡Aæƒ³å†æŸ¥çœ‹ä¸€éåˆšæ‰çš„è¯­è¨€éƒ½æœ‰å“ªäº›ï¼Œäºæ˜¯æŠŠåˆšæ‰çš„æŸ¥è¯¢è¯­å¥åˆæ‰§è¡Œäº†ä¸€éï¼Œç»“æœç¬¬ä¸€æ¬¡æŸ¥è¯¢æœ‰å››æ¡ï¼Œç¬¬äºŒæ¬¡æŸ¥è¯¢æœ‰äº”æ¡ã€‚è¿™å«å¹»è¯»ã€‚</p><h3 id="æ•°æ®åº“éš”ç¦»çº§åˆ«"><a href="#æ•°æ®åº“éš”ç¦»çº§åˆ«" class="headerlink" title="æ•°æ®åº“éš”ç¦»çº§åˆ«"></a>æ•°æ®åº“éš”ç¦»çº§åˆ«</h3><p>ä¸ºäº†è§£å†³ä»¥ä¸Š è„è¯»ï¼Œä¸å¯é‡å¤è¯»ï¼Œå¹»è¯»çš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®æˆ‘ä»¬çš„å®é™…æƒ…å†µæ¥è®¾ç½®æ•°æ®åº“çš„éš”ç¦»çº§åˆ«ï¼š</p><ul><li>è¯»æœªæäº¤</li><li>è¯»æäº¤</li><li>å¯é‡å¤è¯»</li><li>ä¸²è¡ŒåŒ–</li></ul><p>è¿™å››ç§éš”ç¦»çº§åˆ«å¯¹åº”ç€ä¸‰ç§äº‹åŠ¡éš”ç¦»é—®é¢˜ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹å…·ä½“è§£é‡Šï¼š</p><h4 id="ï¼ˆ1ï¼‰è¯»æœªæäº¤"><a href="#ï¼ˆ1ï¼‰è¯»æœªæäº¤" class="headerlink" title="ï¼ˆ1ï¼‰è¯»æœªæäº¤"></a>ï¼ˆ1ï¼‰è¯»æœªæäº¤</h4><p>å°±æ˜¯å¯ä»¥è¯»åˆ°æœªæäº¤çš„å†…å®¹ã€‚å› æ­¤åœ¨è¿™ç§çº§åˆ«ä¸‹ï¼Œæ˜¯ä¸ä¼šåŠ é”çš„ï¼Œå°±ä¼šå¯¼è‡´è„è¯»çš„æƒ…å†µï¼Œå½“ç„¶äº†ï¼Œä¹Ÿä¼šå‡ºç°ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ã€‚</p><h4 id="ï¼ˆ2ï¼‰è¯»æäº¤"><a href="#ï¼ˆ2ï¼‰è¯»æäº¤" class="headerlink" title="ï¼ˆ2ï¼‰è¯»æäº¤"></a>ï¼ˆ2ï¼‰è¯»æäº¤</h4><p>å°±æ˜¯åªèƒ½è¯»åˆ°äº‹åŠ¡å·²ç»æäº¤çš„å†…å®¹ã€‚è¿™æ˜¯å„ç§ç³»ç»Ÿä¸­æœ€å¸¸ç”¨çš„ä¸€ç§éš”ç¦»çº§åˆ«ã€‚åŒ…æ‹¬SQL Serverå’ŒOracleã€‚è¿™ç§éš”ç¦»çº§åˆ«å¯ä»¥é¿å…è„è¯»ã€‚</p><p>è¿™ä¸ªçº§åˆ«ä¹Ÿå¯ä»¥å«åšâ€œå¿«ç…§è¯»â€ï¼Œè¿™æ˜¯æŒ‰ç…§åŸç†æ¥å‘½åçš„ï¼Œå³ï¼šæ˜¯äº‹åŠ¡ä¸­çš„æ¯ä¸ª sql è¯­å¥ç”Ÿæˆä¸€ä¸ª readViewã€‚é‚£å°±æ˜¯ä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¡ sql è¯­å¥ï¼Œä¼šç”Ÿæˆå¤šä¸ª readViewã€‚è€Œæ¯æ¡ sql æ‰§è¡Œæ—¶ï¼Œéƒ½æ˜¯æŸ¥è¯¢æœ€æ–° readView çš„å€¼ï¼Œä»è€ŒæŸ¥å–åˆ°åˆ«çš„äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ã€‚</p><p>ä½†æ˜¯è¯»å·²æäº¤åªèƒ½é¿å…è„è¯»ï¼Œè€Œæ— æ³•è§£å†³ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ã€‚</p><h4 id="ï¼ˆ3ï¼‰å¯é‡å¤è¯»"><a href="#ï¼ˆ3ï¼‰å¯é‡å¤è¯»" class="headerlink" title="ï¼ˆ3ï¼‰å¯é‡å¤è¯»"></a>ï¼ˆ3ï¼‰å¯é‡å¤è¯»</h4><p>ä¸“é—¨é’ˆå¯¹ä¸å¯é‡å¤è¯»çš„éš”ç¦»çº§åˆ«ï¼Œæ˜¯MySQLçš„é»˜è®¤éš”ç¦»çº§åˆ«ã€‚</p><p>åœ¨è¿™ä¸ªçº§åˆ«ä¸‹ï¼Œæ™®é€šçš„æŸ¥è¯¢ä¾ç„¶æ˜¯å¿«ç…§è¯»ï¼Œä½†æ˜¯åœ¨äº‹åŠ¡å¯åŠ¨æ—¶ï¼Œå°±ä¸å…è®¸ä¿®æ”¹ï¼ˆUpdateï¼‰æ“ä½œäº†ï¼Œè€Œä¸å¯é‡å¤è¯»æ­£æ˜¯å› ä¸ºä¸¤æ¬¡è¯»å–ä¹‹é—´å‡ºç°äº†æ•°æ®çš„ä¿®æ”¹æ“ä½œï¼Œè¯»å–ä¹‹åå°±åŠ é”ä¸å…è®¸å…¶ä»–äº‹åŠ¡ä¿®æ”¹è¿™ç§æ“ä½œæ•ˆç‡ä¹Ÿæ¯”è¾ƒå·®ï¼Œè€Œæˆç†Ÿçš„æ•°æ®åº“ï¼Œå‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œéƒ½æ˜¯ä½¿ç”¨äº†ä»¥ä¹è§‚é”ä¸ºç†è®ºåŸºç¡€çš„<strong>MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰</strong>æ¥å®ç°ã€‚</p><p>æ­¤çº§åˆ«ä¸å¯é¿å…å¹»è¯»ï¼Œå› ä¸ºå¹»è¯»æ˜¯ç”±äºæ’å…¥ï¼ˆinsertï¼‰æˆ–è€…åˆ é™¤ï¼ˆdeleteï¼‰æ“ä½œäº§ç”Ÿçš„ã€‚</p><h4 id="ï¼ˆ4ï¼‰ä¸²è¡ŒåŒ–"><a href="#ï¼ˆ4ï¼‰ä¸²è¡ŒåŒ–" class="headerlink" title="ï¼ˆ4ï¼‰ä¸²è¡ŒåŒ–"></a>ï¼ˆ4ï¼‰ä¸²è¡ŒåŒ–</h4><p>  è¿™æ˜¯æ•°æ®åº“çš„æœ€é«˜éš”ç¦»çº§åˆ«ï¼Œåœ¨è¿™ç§çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡ä¸²è¡ŒåŒ–çš„é¡ºåºæ‰§è¡Œã€‚ä½†æ˜¯æ•ˆç‡å¤ªå·®ï¼ŒåŸºæœ¬ä¸ä¼šä½¿ç”¨ã€‚</p><p><strong>è„è¯»ï¼šselecté—®é¢˜</strong></p><p><strong>ä¸å¯é‡å¤è¯»ï¼šupdateé—®é¢˜</strong></p><p><strong>å¹»è¯»ï¼šinsert/deleteé—®é¢˜</strong></p>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> ORACLE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æˆ‘çš„ä¸ªäººåšå®¢</title>
      <link href="2020/10/28/first/"/>
      <url>2020/10/28/first/</url>
      
        <content type="html"><![CDATA[<p>æ¬¢è¿å¤§å®¶æ¥åˆ°æˆ‘çš„ä¸ªäººåšå®¢ï¼Œè®©æˆ‘ä»¬ä¸€èµ·å­¦ä¹ ä¸€èµ·è¿›æ­¥ã€‚</p><a id="more"></a><p>æˆ‘å°†åœ¨æ­¤æ›´æ–°åŒ…æ‹¬ä½†ä¸é™äºï¼šç¼–ç ï¼Œè®¾è®¡ï¼Œæ•°æ®åº“ï¼Œéšç¬”ç±»å‹çš„å†…å®¹ï¼›å¦‚æœæœ‰æƒ³å’Œæˆ‘æ¢è®¨çš„å†…å®¹ï¼Œè¯·è¿”å›é¦–é¡µæŸ¥æ‰¾åˆé€‚çš„è”ç³»æ–¹å¼è”ç³»æˆ‘å§ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> keep learning </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é™æµç®—æ³•è§£æ</title>
      <link href="2020/10/28/current-limiting-algorithm/"/>
      <url>2020/10/28/current-limiting-algorithm/</url>
      
        <content type="html"><![CDATA[<p>å¼•è¨€ï¼šç›˜ç‚¹ä¸€ä¸‹å¸¸ç”¨çš„å‡ ç§é™æµç®—æ³•çš„åŸç†ä¸å®ç°ã€‚</p><a id="more"></a><h2 id="1ã€å›ºå®šæ—¶é—´çª—å£é™æµ"><a href="#1ã€å›ºå®šæ—¶é—´çª—å£é™æµ" class="headerlink" title="1ã€å›ºå®šæ—¶é—´çª—å£é™æµ"></a>1ã€å›ºå®šæ—¶é—´çª—å£é™æµ</h2><p>â€‹        å›ºå®šæ—¶é—´çª—å£é™æµå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯ä½¿ç”¨è®¡æ•°å™¨åœ¨å‘¨æœŸå†…ç´¯åŠ è®¿é—®æ¬¡æ•°ï¼Œå½“è¯·æ±‚æ¬¡æ•°è¾¾åˆ°è®¾å®šçš„é™æµå€¼æ—¶ï¼Œè§¦å‘é™æµç­–ç•¥ã€‚ä¸‹ä¸€ä¸ªå‘¨æœŸå¼€å§‹æ—¶ï¼Œå°†è®¡æ•°å™¨æ¸…é›¶ï¼Œé‡æ–°è®¡æ•°ã€‚è¿™ç§ç®—æ³•æ˜¯é™æµç®—æ³•ä¸­æœ€ç®€å•çš„ä¸€ç§ï¼Œæ— è®ºç†è§£è¿˜æ˜¯å®ç°ã€‚<strong>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Redisçš„incråŸå­è‡ªå¢å’Œçº¿ç¨‹å®‰å…¨å®ç°</strong></p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1500511/1599120998722-dc689c17-7cc4-4b7b-ac4b-b1409ca2e224.png" alt="image.png"></p><p>â€‹        è¿™ä¸ªç®—æ³•é€šå¸¸ç”¨äºQPSé™æµå’Œç»Ÿè®¡è®¿é—®æ€»é‡ï¼Œä½†å¯¹äºé™åˆ¶ç²’åº¦è¾ƒå¤§çš„æƒ…å†µä¸‹ä¼šæœ‰æ¯”è¾ƒä¸¥é‡çš„ä¸´ç•Œé—®é¢˜ï¼šå½“ä¸Šä¸€ä¸ªå‘¨æœŸçš„100æ¬¡è¯·æ±‚åœ¨æœ€å10mså†…æŠµè¾¾ï¼Œå½“å‰å‘¨æœŸçš„100ä¸ªè¯·æ±‚åœ¨æœ¬ç§’çš„å¼€å¤´10mså†…æŠµè¾¾ï¼Œæˆ‘ä»¬æ”¾å¤§åˆ°å‘¨æœŸæ¥çœ‹ï¼Œæ¯ä¸ªå‘¨æœŸéƒ½åªæœ‰100çš„è¯·æ±‚é‡ï¼Œæœªè§¦å‘æˆ‘ä»¬çš„é™æµç­–ç•¥ï¼Œä½†æ˜¯ç¼©å°åˆ°ä¸Šä¸ªå‘¨æœŸçš„æœ€å10mså’Œæœ¬å‘¨æœŸçš„å¼€å¤´10msæ¥çœ‹ï¼ŒæœåŠ¡å™¨åœ¨20mså†…æ¥æ”¶åˆ°äº†200ä¸ªè¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚é‡è¶…å‡ºäº†æˆ‘ä»¬è®¾å®šçš„é™æµæ•°é‡ï¼Œä½†å´æ²¡æœ‰è§¦å‘é™æµç­–ç•¥ã€‚</p><p>ç”±æ­¤å¯è§ï¼Œå›ºå®šæ—¶é—´çª—å£é™æµç®—æ³•ï¼Œå¯¹äºç²’åº¦è¾ƒå¤§çš„é™æµå‘¨æœŸæ¥è¯´ï¼Œæœ‰å¾ˆå¤§çš„å¼Šç«¯ã€‚</p><h2 id="2ã€æ»‘åŠ¨æ—¶é—´çª—å£é™æµ"><a href="#2ã€æ»‘åŠ¨æ—¶é—´çª—å£é™æµ" class="headerlink" title="2ã€æ»‘åŠ¨æ—¶é—´çª—å£é™æµ"></a>2ã€æ»‘åŠ¨æ—¶é—´çª—å£é™æµ</h2><p>â€‹        ç¬¬äºŒç§æ˜¯æ»‘åŠ¨æ—¶é—´çª—å£é™æµç®—æ³•ï¼Œè¿™ç§ç®—æ³•å°†æ—¶é—´å‘¨æœŸåˆ†ä¸ºNä¸ªå°å‘¨æœŸï¼Œåˆ†åˆ«è®°å½•æ¯ä¸ªå°å‘¨æœŸå†…çš„è®¿é—®æ¬¡æ•°ï¼Œå¹¶ä¸”æ ¹æ®æ—¶é—´åˆ é™¤è¿‡æœŸå‘¨æœŸè®¿é—®æ¬¡æ•°çš„è®°å½•ã€‚</p><p>å¦‚å›¾ï¼Œå‡è®¾å°†æ—¶é—´å‘¨æœŸè®¾ç½®ä¸º1minï¼Œæˆ‘ä»¬å¯ä»¥å°†1minå†åˆ’åˆ†ä¸º2ä¸ªå°å‘¨æœŸï¼Œç»Ÿè®¡æ¯ä¸ªå°å‘¨æœŸå†…çš„è®¿é—®æ¬¡æ•°ï¼Œåˆ™å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€ä¸ªå‘¨æœŸçš„è®¿é—®æ¬¡æ•°ä¸º75ï¼Œç¬¬äºŒä¸ªå‘¨æœŸè¶…è¿‡äº†æˆ‘ä»¬é™åˆ¶çš„100ï¼Œåˆ™ä¼šè§¦å‘é™æµç­–ç•¥</p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1500511/1599121613919-72d66c69-5832-495a-b604-0eb8260e7e76.png" alt="image.png"></p><p>ç”±æ­¤å¯è§ï¼Œå½“æ»‘åŠ¨çª—å£åˆ’åˆ†çš„æ ¼å­è¶Šç»†è‡´ï¼Œé‚£ä¹ˆæ»‘åŠ¨çª—å£çš„æ»šåŠ¨å°±ä¼šè¶Šå¹³æ»‘ï¼Œé™æµçš„ç»Ÿè®¡å°±ä¼šè¶Šç²¾ç¡®ã€‚</p><h2 id="3ã€ä»¤ç‰Œæ¡¶é™æµ"><a href="#3ã€ä»¤ç‰Œæ¡¶é™æµ" class="headerlink" title="3ã€ä»¤ç‰Œæ¡¶é™æµ"></a>3ã€ä»¤ç‰Œæ¡¶é™æµ</h2><p>â€‹        ä»¤ç‰Œæ¡¶ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ˜¯ä»¥ç¨‹åºä»¥ä¸€ä¸ªå›ºå®šçš„é€Ÿåº¦Sï¼ˆS=æ—¶é—´å‘¨æœŸ/é™æµå€¼ï¼‰å‘ä»¤ç‰Œæ¡¶ä¸­å¢åŠ ä»¤ç‰Œï¼Œç›´è‡³ä»¤ç‰Œæ¡¶æ»¡ï¼Œè¯·æ±‚åˆ°è¾¾æ—¶å…ˆåˆ°ä»¤ç‰Œæ¡¶ä¸­è¯·æ±‚ä»¤ç‰Œï¼Œè·å–åˆ°ä»¤ç‰Œåˆ™é€šè¿‡è¯·æ±‚ï¼Œå¦åˆ™è§¦å‘é™æµ</p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1500511/1599122374364-3bb91b33-8cdb-4dcc-b574-4a965e5f8b4d.png" alt="img"></p><h2 id="4ã€æ¼æ¡¶é™æµ"><a href="#4ã€æ¼æ¡¶é™æµ" class="headerlink" title="4ã€æ¼æ¡¶é™æµ"></a>4ã€æ¼æ¡¶é™æµ</h2><p>â€‹        æ¼æ¡¶é™æµåˆè¢«æˆä¸ºæ¼æ–—é™æµï¼Œæˆ‘ä»¬å°†è®¿é—®è¯·æ±‚ç›´æ¥æ”¾å…¥æ¼æ¡¶ï¼Œå¦‚å½“å‰å®¹é‡å·²ç»è¾¾åˆ°ä¸Šé™ï¼Œåˆ™ç›´æ¥è§¦å‘é™æµã€‚æ¼æ¡¶ä»¥å›ºå®šçš„é€Ÿç‡è¿›è¡Œé‡Šæ”¾è®¿é—®è¯·æ±‚ï¼ˆå³å…è®¸è¯·æ±‚é€šè¿‡ï¼‰ï¼Œç›´åˆ°æ¼æ¡¶ä¸ºç©ºã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1500511/1599122555655-41550a62-f23f-4ba6-90eb-14469639a719.png" alt="img"></p><p>é™„ä¸Šjavaç‰ˆçš„å®ç°ï¼š</p><pre><code>/** * Created by zhangbw */public class FunnelRateLimiter {    static class Funnel {        int capacity;   //å®¹é‡        float leakingRate; //é€Ÿç‡        int leftQuota;//å‰©ä½™å®¹é‡        long leakingTs;//ä¸Šæ¬¡æ¼æ°´çš„æ—¶é—´        public Funnel(int capacity, float leakingRate) {            this.capacity = capacity;            this.leakingRate = leakingRate;            this.leftQuota = capacity;            this.leakingTs = System.currentTimeMillis();        }        void makeSpace() {            long nowTs = System.currentTimeMillis();            long deltaTs = nowTs - leakingTs;//è·ç¦»ä¸Šä¸€æ¬¡æ¼æ°´è¿‡å»äº†å¤šé•¿æ—¶é—´            int deltaQuota = (int) (deltaTs * leakingRate);//å¯ä»¥è…¾å‡ºå¤šå°‘ç©ºé—´            //é—´éš”æ—¶é—´å¤ªé•¿ ï¼Œæ•´æ•°æ•°å­—è¿‡å¤§æº¢å‡º            if (deltaQuota &lt; 0) {                this.leftQuota = capacity;                this.leakingTs = nowTs;                return;            }                //è…¾å‡ºç©ºé—´å¤ªå° ï¼Œæœ€å°å•ä½æ˜¯1                if (deltaQuota &lt; 1) {                    return;                }                this.leftQuota += deltaQuota;                this.leakingTs = nowTs;                if (this.leftQuota &gt; this.capacity) {                    this.leftQuota = this.capacity;                }            }        boolean watering(int quota) {            makeSpace();            if (this.leftQuota &gt;= quota) {                this.leftQuota -= quota;                return true;            }            return false;        }        private Map&lt;String, Funnel&gt; funnels = new HashMap&lt;&gt;();        public boolean isActionAllowed(String userId, String actionKey, int capacity, float leakingRate) {            String key = String.format("%s:%s", userId, capacity);            Funnel funnel = funnels.get(key);            if (funnel == null) {                funnel = new Funnel(capacity, leakingRate);                funnels.put(key, funnel);            }            return funnel.watering(1); //éœ€è¦ 1 ä¸ª quota        }    }}</code></pre><p>Redis4.0ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªé™æµçš„Redisæ¨¡å—ï¼Œå«åš<a href="https://github.com/brandur/redis-cell">Redis-Cell</a>ï¼Œè¯¥æ¨¡å—ä½¿ç”¨äº†æ¼æ–—ç®—æ³•ï¼Œå¹¶æä¾›äº†åŸå­çš„é™æµæŒ‡ä»¤ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</p><p>GuavaåŒ…å…¶å®å¯¹å„ç§é™æµç­–ç•¥éƒ½æœ‰å®ç°ï¼Œè¯¦æƒ…å¯è§ï¼š<a href="https://guava.dev/releases/19.0/api/docs/index.html?com/google/common/util/concurrent/RateLimiter.html">RateLimiter</a></p>]]></content>
      
      
      <categories>
          
          <category> ç¼–ç ä¸è®¾è®¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¼–ç  </tag>
            
            <tag> java </tag>
            
            <tag> é™æµ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
